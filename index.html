<script>
const v        = document.getElementById('vid');
const btnWall  = document.getElementById('btnWall');
const btnLeft  = document.getElementById('btnLeft');
const btnRight = document.getElementById('btnRight');
const btnUp    = document.getElementById('btnUp');
const btnDown  = document.getElementById('btnDown');

// æ—‹è½‰æŒ‰éˆ•
const btnRotL     = document.getElementById('btnRotL');
const btnRotR     = document.getElementById('btnRotR');
const btnTiltUp   = document.getElementById('btnTiltUp');
const btnTiltDown = document.getElementById('btnTiltDown');

// ç¸®æ”¾æŒ‰éˆ•
const btnScaleUp   = document.getElementById('btnScaleUp');
const btnScaleDown = document.getElementById('btnScaleDown');

const statusEl = document.getElementById('status');
const posInfo  = document.getElementById('posInfo');

const markers = Array.from(document.querySelectorAll('.marker'));
const planes  = Array.from(document.querySelectorAll('.wall-plane'));

let isWallMode = false;
// ðŸ‘‰ åŒä¸€æ™‚é–“åªå…è¨±ä¸€é¡†éŒ¨é»žç•¶ä¸»è§’
let activeMarkerIndex = null;

// ç‰†çš„å¯¦éš›å°ºå¯¸ï¼ˆå…¬å°ºï¼‰
const WALL_W = 15.14;
const WALL_H = 3.283;

// æ¯ä¸€é¡†éŒ¨é»žå„è‡ªçš„ã€Œç‰†ä½ç½®å¾®èª¿å€¼ã€
const wallPosList = [
  { x: 3.10,  y: 0.00, z: 0 }, // éŒ¨é»ž 0
  { x: 1.40,  y: 0.00, z: 0 }, // éŒ¨é»ž 1
  { x: 0.00,  y: 0.00, z: 0 }, // éŒ¨é»ž 2
  { x:-3.40,  y: 0.00, z: 0 }  // éŒ¨é»ž 3
];

// æ¯ä¸€é¡†éŒ¨é»žå„è‡ªçš„ã€Œç‰†æ—‹è½‰å¾®èª¿å€¼ã€ï¼ˆè§’åº¦ï¼Œåº¦æ•¸ï¼‰
const wallRotList = [
  { x: 0,   y: 0, z: 0 }, // éŒ¨é»ž 0
  { x: 0,   y: 0, z: 0 }, // éŒ¨é»ž 1
  { x: 1.0, y: 0, z: 0 }, // éŒ¨é»ž 2
  { x: 0,   y: 0, z: 0 }  // éŒ¨é»ž 3
];

// æ¯ä¸€é¡†éŒ¨é»žå„è‡ªçš„ç¸®æ”¾å€çŽ‡
const wallScaleList = [
  { s: 0.60 }, // éŒ¨é»ž 0
  { s: 0.60 }, // éŒ¨é»ž 1
  { s: 0.60 }, // éŒ¨é»ž 2
  { s: 0.60 }  // éŒ¨é»ž 3
];

// æ‰‹æ©Ÿäº’å‹•ä¸€æ¬¡çµ¦å½±ç‰‡æ’­æ”¾æ¬Šé™
function tryPlay(){ v.play().catch(()=>{}); }
['loadeddata','canplay'].forEach(ev => v.addEventListener(ev, tryPlay, {once:true}));
window.addEventListener('pointerdown', tryPlay, {once:true});
window.addEventListener('touchstart', tryPlay, {once:true, passive:true});

// å½±ç‰‡æ­£æ’­ â†” åå‘ã€Œæ‰‹å‹•å€’å¸¶ã€ ping-pong å¾ªç’°
let pingpongDirection = 1;   // 1 = æ­£æ’­, -1 = åå‘å€’å¸¶
let reverseTimer = null;

// ä¸€é–‹å§‹å…ˆæ­£æ’­
v.playbackRate = 1;

// æ­£å¸¸å¾€å‰æ’­åˆ°åº• â†’ æ”¹æˆåå‘ã€Œå€’å¸¶ã€
v.addEventListener('ended', () => {
  startReverse();
});

function startForward(){
  pingpongDirection = 1;
  if (reverseTimer){
    clearInterval(reverseTimer);
    reverseTimer = null;
  }
  v.playbackRate = 1;
  if (v.currentTime <= 0){
    v.currentTime = 0.01;
  }
  v.play().catch(()=>{});
}

function startReverse(){
  pingpongDirection = -1;
  if (reverseTimer){
    clearInterval(reverseTimer);
  }
  v.pause();

  if (!isFinite(v.duration) || v.duration === 0){
    return; // é¿å…å½±ç‰‡é‚„æ²’æº–å‚™å¥½
  }

  if (v.currentTime >= v.duration){
    v.currentTime = v.duration - 0.03;
  }

  const step = 1/30; // æ¯æ¬¡å€’å¸¶ 1/30 ç§’ï¼Œå¤§æ¦‚ 30fps
  reverseTimer = setInterval(() => {
    if (v.currentTime <= 0.03){
      // å€’å¸¶å›žåˆ°é–‹é ­ â†’ å†æ­£æ’­
      clearInterval(reverseTimer);
      reverseTimer = null;
      startForward();
    } else {
      v.currentTime = Math.max(0, v.currentTime - step);
    }
  }, 33); // æ¯ 33ms æ›´æ–°ä¸€æ¬¡ï¼ˆç´„ 30fpsï¼‰
}

function updatePosLabel(){
  if(activeMarkerIndex === null){
    posInfo.textContent = '';
    return;
  }
  const p = wallPosList[activeMarkerIndex];
  const r = wallRotList[activeMarkerIndex];
  const s = wallScaleList[activeMarkerIndex];
  posInfo.textContent =
    `éŒ¨é»ž #${activeMarkerIndex} ` +
    `pos x=${p.x.toFixed(2)} y=${p.y.toFixed(2)} ` +
    `| rot x=${r.x.toFixed(1)} y=${r.y.toFixed(1)} z=${r.z.toFixed(1)} ` +
    `| scale=${s.s.toFixed(2)}`;
}

// ç¶å®šæ¯ä¸€é¡†éŒ¨é»žçš„äº‹ä»¶
markers.forEach((marker, idx) => {
  const plane = planes[idx];

  marker.addEventListener('targetFound', () => {
    console.log('ðŸŽ¯ targetFound', idx);

    // â­ æ ¸å¿ƒï¼šå¦‚æžœå·²ç¶“æœ‰ä¸€é¡†åœ¨ç”¨ï¼Œè€Œä¸”ä¸æ˜¯é€™ä¸€é¡† â†’ ç›´æŽ¥å¿½ç•¥
    if (activeMarkerIndex !== null && activeMarkerIndex !== idx) {
      console.log('ðŸ”’ å·²æœ‰æ´»å‹•éŒ¨é»ž #'+activeMarkerIndex+'ï¼Œå¿½ç•¥ #'+idx);
      return;
    }

    // æ²’æœ‰æ´»å‹•éŒ¨é»žæ™‚ï¼Œæ‰è®“é€™ä¸€é¡†ä¸Šä½
    if (activeMarkerIndex === null) {
      activeMarkerIndex = idx;
      console.log('âœ… è¨­å®šæ´»å‹•éŒ¨é»ž #'+idx);
    }

    btnWall.disabled = false;
    statusEl.textContent = `å·²æŠ“åˆ°éŒ¨é»ž #${activeMarkerIndex}ï¼Œå¯åˆ‡åˆ°å¤§ç‰†`;
    v.play().catch(()=>{});

    // ç¢ºä¿ plane é¡¯ç¤º
    plane.object3D.visible = true;

    if(isWallMode){
      // å¤§ç‰†æ¨¡å¼ä¸‹ï¼šåªé¡¯ç¤ºé€™é¡†éŒ¨é»žçš„ planeï¼Œå…¶é¤˜é—œæŽ‰
      planes.forEach((p, i) => {
        p.object3D.visible = (i === activeMarkerIndex);
      });

      const pPos   = wallPosList[activeMarkerIndex];
      const pRot   = wallRotList[activeMarkerIndex];
      const pScale = wallScaleList[activeMarkerIndex].s;

      plane.setAttribute('position', `${pPos.x} ${pPos.y} ${pPos.z}`);
      plane.setAttribute('rotation', `${pRot.x} ${pRot.y} ${pRot.z}`);
      plane.object3D.scale.set(pScale, pScale, pScale);
    }

    updatePosLabel();
  });

  marker.addEventListener('targetLost', () => {
    console.log('âš  targetLost', idx);

    // å¦‚æžœé€™é¡†ä¸æ˜¯æ­£åœ¨ç”¨çš„é‚£ä¸€é¡† â†’ å¿½ç•¥
    if (activeMarkerIndex !== idx) {
      console.log('å¿½ç•¥éžæ´»å‹•éŒ¨é»ž targetLost #'+idx);
      return;
    }

    statusEl.textContent = `éŒ¨é»ž #${idx} éºå¤±ï¼Œè«‹å°æº–ä»»ä¸€éŒ¨é»ž`;
    plane.object3D.visible = false;

    // æŠŠã€Œæ´»å‹•éŒ¨é»žã€æ¸…æŽ‰ï¼Œè®“ä¸‹ä¸€é¡†å¯ä»¥æŽ¥æ‰‹
    activeMarkerIndex = null;
    updatePosLabel();
  });
});

// åˆ‡åˆ°å¤§ç‰†ï¼šæ”¾å¤§æ‰€æœ‰ planeï¼Œå¯¦éš›é¡¯ç¤ºåªé¡¯ç¤ºã€Œç›®å‰æ´»å‹•çš„é‚£ä¸€é¡†ã€
btnWall.addEventListener('click', () => {
  if(activeMarkerIndex === null) return;

  planes.forEach((plane, idx) => {
    plane.setAttribute('width',  WALL_W);
    plane.setAttribute('height', WALL_H);

    const pPos   = wallPosList[idx];
    const pRot   = wallRotList[idx];
    const pScale = wallScaleList[idx].s;

    plane.setAttribute('position', `${pPos.x} ${pPos.y} ${pPos.z}`);
    plane.setAttribute('rotation', `${pRot.x} ${pRot.y} ${pRot.z}`);
    plane.object3D.scale.set(pScale, pScale, pScale);

    // åªé¡¯ç¤ºæ´»å‹•éŒ¨é»žçš„ plane
    plane.object3D.visible = (idx === activeMarkerIndex);
  });

  isWallMode = true;
  statusEl.textContent = 'å¤§ç‰†æ¨¡å¼ï¼šå¯ç”¨ç®­é ­å¾®èª¿ä½ç½®ï¼‹æ—‹è½‰ï¼‹ç¸®æ”¾ï¼ˆæ¯é¡†éŒ¨é»žå„è‡ªè¨˜éŒ„ï¼‰';
  updatePosLabel();
  v.play().catch(()=>{});
});

// å¹³ç§»å¾®èª¿ï¼ˆåªå‹•ç›®å‰æ´»å‹•éŒ¨é»žï¼‰
function nudge(dx, dy){
  if(!isWallMode) return;
  if(activeMarkerIndex === null) return;

  const p = wallPosList[activeMarkerIndex];
  p.x += dx;
  p.y += dy;

  const plane = planes[activeMarkerIndex];
  plane.setAttribute('position', `${p.x} ${p.y} ${p.z}`);
  updatePosLabel();
}

// æ—‹è½‰å¾®èª¿
function nudgeRot(dx, dy, dz){
  if(!isWallMode) return;
  if(activeMarkerIndex === null) return;

  const r = wallRotList[activeMarkerIndex];
  r.x += dx;
  r.y += dy;
  r.z += dz;

  const plane = planes[activeMarkerIndex];
  plane.setAttribute('rotation', `${r.x} ${r.y} ${r.z}`);
  updatePosLabel();
}

// ç¸®æ”¾å¾®èª¿
function nudgeScale(ds){
  if(!isWallMode) return;
  if(activeMarkerIndex === null) return;

  const s = wallScaleList[activeMarkerIndex];
  s.s = Math.max(0.01, s.s + ds);

  const plane = planes[activeMarkerIndex];
  plane.object3D.scale.set(s.s, s.s, s.s);
  updatePosLabel();
}

// å¹³ç§»æŒ‰éˆ•
btnLeft .addEventListener('click', () => nudge(-0.1, 0));
btnRight.addEventListener('click', () => nudge( 0.1, 0));
btnUp   .addEventListener('click', () => nudge(0,  0.1));
btnDown .addEventListener('click', () => nudge(0, -0.1));

// æ—‹è½‰æŒ‰éˆ•
btnRotL     .addEventListener('click', () => nudgeRot(0, 0, -1)); // Z è»¸é€†æ™‚é‡ 1Â°
btnRotR     .addEventListener('click', () => nudgeRot(0, 0,  1)); // Z è»¸é †æ™‚é‡ 1Â°
btnTiltUp   .addEventListener('click', () => nudgeRot(-1, 0, 0)); // X è»¸ä¸Šå‚¾ 1Â°
btnTiltDown .addEventListener('click', () => nudgeRot( 1, 0, 0)); // X è»¸ä¸‹å‚¾ 1Â°

// ç¸®æ”¾æŒ‰éˆ•ï¼ˆæ¯æ¬¡ 0.1 å€ï¼‰
btnScaleUp  .addEventListener('click', () => nudgeScale( 0.1));
btnScaleDown.addEventListener('click', () => nudgeScale(-0.1));

updatePosLabel();
</script>
