<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>å¤§ç‰† ARï½œéŒ¨é»ï¼‹å¤§ç‰†ç¤ºæ„ç‰ˆ</title>

<!-- å®˜æ–¹ç‰ˆæœ¬ï¼šA-Frame 1.6.0 + mind-ar 1.2.5 -->
<script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

<style>
  body{
    margin:0;
    overflow:hidden;
    background:#000;
    color:#0f0;
    font-family:monospace;
  }

  /* ç°¡å–®ä¸€æ¢ä¸Šæ–¹å·¥å…·åˆ— */
  #top{
    position:fixed;
    left:8px;
    top:8px;
    z-index:10;
    display:flex;
    gap:6px;
    align-items:center;
    padding:4px 6px;
    background:rgba(0,0,0,.4);
    border-radius:8px;
  }
  #top button{
    padding:4px 8px;
    font-size:13px;
  }
  #status{
    font-size:12px;
    opacity:.8;
  }
</style>
</head>
<body>

<div id="top">
  <button id="btnWall" disabled>åˆ‡åˆ°å¤§ç‰†</button>
  <span id="status">ç­‰å¾…éŒ¨é»â€¦</span>
</div>

<a-scene
  mindar-image="imageTargetSrc: ./wall-anchor.mind?v=20251113; autoStart: true"
  color-space="sRGB"
  renderer="colorManagement: true; physicallyCorrectLights: true"
  vr-mode-ui="enabled: false"
  device-orientation-permission-ui="enabled: false">

  <a-assets timeout="30000">
    <video id="vid" src="./video.mp4"
           preload="auto"
           playsinline webkit-playsinline
           muted
           crossorigin="anonymous"></video>
  </a-assets>

  <!-- camera -->
  <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

  <!-- markerï¼šä¸€é–‹å§‹æ›ä¸€å¡Šå°å¹³é¢åœ¨éŒ¨é»ä¸Š -->
  <a-entity id="marker" mindar-image-target="targetIndex:0">
    <!-- å°æ¸¬è©¦å¹³é¢ï¼ˆç¢ºèª tracking OK ç”¨ï¼‰ -->
    <a-plane id="markerPlane"
      position="0 0 0"
      width="0.8" height="0.4"
      material="shader:flat; src:#vid; side:double; transparent:true; alphaTest:0.01">
    </a-plane>
  </a-entity>

  <!-- å¤§ç‰†å¹³é¢ï¼šä¸€é–‹å§‹ä¸é¡¯ç¤ºï¼ŒæŒ‰éˆ•å¾Œæ‰åˆ‡éä¾† -->
  <a-entity id="wallRoot" visible="false">
    <a-plane id="wallPlane"
      position="0 0 0"
      width="3"  <!-- å…ˆç”¨ 3 å…¬å°ºç¤ºæ„ï¼Œä¹‹å¾Œæ”¹ 15.14 -->
      height="3 * 3.283 / 15.14"
      material="shader:flat; src:#vid; side:double; transparent:true; alphaTest:0.01">
    </a-plane>
  </a-entity>

</a-scene>

<script>
const v       = document.getElementById('vid');
const marker  = document.getElementById('marker');
const markerPlane = document.getElementById('markerPlane');
const wallRoot   = document.getElementById('wallRoot');
const wallPlane  = document.getElementById('wallPlane');
const btnWall    = document.getElementById('btnWall');
const statusEl   = document.getElementById('status');

let hasFound = false;

/* æ‰‹æ©Ÿè¦äº’å‹•æ‰èƒ½æ’­ä¸€æ¬¡å½±ç‰‡ */
function tryPlay(){ v.play().catch(()=>{}); }
['loadeddata','canplay'].forEach(ev => v.addEventListener(ev, tryPlay, {once:true}));
window.addEventListener('pointerdown', tryPlay, {once:true});
window.addEventListener('touchstart', tryPlay, {once:true, passive:true});

/* éŒ¨é»äº‹ä»¶ */
marker.addEventListener('targetFound', () => {
  console.log('ğŸ¯ targetFound');
  statusEl.textContent = 'å·²é–å®šéŒ¨é»ï¼Œå¯åˆ‡åˆ°å¤§ç‰†';
  hasFound = true;
  btnWall.disabled = false;
  v.play().catch(()=>{});
});

marker.addEventListener('targetLost', () => {
  console.log('âš  targetLost');
  statusEl.textContent = 'éŒ¨é»éºå¤±ï¼Œè«‹å†å°æº–';
  hasFound = false;
  // å…ˆä¸ disabled æŒ‰éˆ•ï¼Œæ–¹ä¾¿ä½ æ¸¬è©¦
});

/* åˆ‡åˆ°å¤§ç‰†ï¼šæŠŠå¤§ç‰† entity æ›åˆ° marker åº•ä¸‹ï¼Œé¡¯ç¤ºå®ƒã€éš±è—å°å¹³é¢ */
btnWall.addEventListener('click', () => {
  if(!hasFound) return;

  // æŠŠ wallRoot æ›åˆ° marker åº•ä¸‹ï¼Œè·Ÿè‘—éŒ¨é»èµ°
  marker.appendChild(wallRoot);

  // é€™è£¡å…ˆç”¨ 3 å…¬å°ºå¯¬ç¤ºæ„ï¼Œæ¯”ä¾‹ç…§ 15.14Ã—3.283 è¨­å®š
  const wallWidth  = 3.0;
  const wallHeight = wallWidth * (3.283 / 15.14);
  wallPlane.setAttribute('width',  wallWidth);
  wallPlane.setAttribute('height', wallHeight);
  wallRoot.setAttribute('position', '0 0 0');   // å¯ä¹‹å¾Œå†å¾®èª¿ offset
  wallRoot.setAttribute('visible', 'true');

  // æŠŠå° marker å¹³é¢é—œæ‰
  markerPlane.setAttribute('visible', 'false');

  statusEl.textContent = 'å·²åˆ‡æ›åˆ°å¤§ç‰†ï¼ˆ3m ç¤ºæ„ç‰ˆï¼‰';
  v.play().catch(()=>{});
});
</script>
</body>
</html>
