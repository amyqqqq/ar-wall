<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>å¤§ç‰† ARï½œé˜²åç§»å¼·åˆ¶ç‰ˆ</title>

<!-- A-Frame + MindAR -->
<script src="https://unpkg.com/aframe@1.4.2/dist/aframe.min.js"></script>
<script src="https://unpkg.com/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

<style>
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:#000;color:#0f0;font-family:monospace}
  /* é—œéµï¼šæ•´å€‹é é¢å›ºå®šç‚º 100vw/100vhï¼Œé¿å…ç€è¦½å™¨ UI é€ æˆ reflow */
  body{position:fixed; inset:0; overflow:hidden}

  /* åªå‹• UIï¼Œä¸å‹• A-Frame é è¨­ canvas è¦å‰‡ */
  #top{position:fixed;left:8px;top:8px;z-index:100003;display:flex;gap:6px;align-items:center}
  #top button{padding:8px 12px}
  #status{background:#000a;padding:4px 8px;border-radius:6px}
  #log{position:fixed;left:8px;bottom:8px;right:8px;height:120px;overflow:auto;background:rgba(0,0,0,.55);padding:8px;z-index:100003;font-size:12px;line-height:1.25}
  #tfBadge{position:fixed;right:12px;top:40px;z-index:100003;background:#29b6f6;color:#000;padding:6px 10px;border-radius:8px;display:none;font-weight:bold;}

  /* é—œéµï¼šæŠŠ MindAR çš„å®¹å™¨èˆ‡å…¶å…§éƒ¨ video/canvas å¼·åˆ¶é‹ªæ»¿è¦–çª— */
  .mindar-container{
    position:fixed !important; inset:0 !important;
    width:100vw !important; height:100vh !important; overflow:hidden !important; 
    touch-action:none !important;
  }
  .mindar-container video, .mindar-container canvas{
    position:absolute !important; left:0 !important; top:0 !important;
    width:100% !important; height:100% !important;
  }
  /* ä¸è¦ object-fitï¼Œé¿å…æ¯”ä¾‹ç•°å¸¸ï¼›è‹¥ä»è¦‹é»‘é‚Šå†æ”¹æˆ cover */
  .mindar-container video{object-fit:fill !important; transform:none !important}

  /* é—œæ‰è¨ºæ–·åŸç”Ÿæ’­æ”¾å™¨èˆ‡é¢æ¿çš„é è¨­é¡¯ç¤ºï¼Œé¿å…ã€Œå³ä¸‹è§’çŸ©å½¢ã€èª¤åˆ¤ */
  #nativeV{display:none !important}
  #diag{display:none !important}

  /* MindAR å…§å»º UI å…¨éš±è— */
  .mindar-ui-loading,.mindar-ui-scanning{display:none !important;}
</style>
</head>
<body>
<div id="tfBadge">ğŸ¯ targetFound</div>
<div id="top">
  <button id="btnStart">å•Ÿå‹• AR</button>
  <button id="btnForcePlay">â–¶ æ‰‹å‹•æ’­æ”¾</button>
  <button id="btnWall" disabled>åˆ‡åˆ°å¤§ç‰†</button>
  <span id="status">æœªå•Ÿå‹•</span>
</div>
<div id="log"></div>

<!-- AR å ´æ™¯ï¼ˆè®“ MindAR è‡ªå·±å»ºæ§‹ DOMï¼›æ­¤è™•ä¸åŠ  embeddedã€ä¸è¦†å¯« canvasï¼‰ -->
<a-scene
  color-space="sRGB"
  vr-mode-ui="enabled:false"
  device-orientation-permission-ui="enabled:false"
  mindar-image="imageTargetSrc: ./wall-anchor.mind; autoStart: false; maxTrack: 1"
  renderer="alpha:true; colorManagement:true; physicallyCorrectLights:true">

  <a-assets timeout="30000">
    <video id="vid" src="./video.mp4" preload="auto" playsinline webkit-playsinline muted crossorigin="anonymous"></video>
  </a-assets>

  <a-entity id="marker" mindar-image-target="targetIndex:0">
    <a-plane id="testOnMarker" position="0 0 0.01" width="0.6" height="0.13"
      material="shader:flat; src:#vid; side:double; transparent:true; alphaTest:0.01" visible="false"></a-plane>
  </a-entity>

  <a-entity id="wallPlane" visible="false">
    <a-plane id="wallVideo" width="15.14" height="3.283" position="0 0 0"
      material="shader:flat; src:#vid; side:double; transparent:true; alphaTest:0.01"></a-plane>
  </a-entity>

  <a-entity camera="facingMode: environment"></a-entity>
</a-scene>

<script>
const logEl=document.getElementById('log');
const log=s=>{console.log(s);logEl.textContent+=s+"\n";logEl.scrollTop=logEl.scrollHeight;}
const statusEl=document.getElementById('status');
const v=document.getElementById('vid');
const wall=document.getElementById('wallPlane');
const wallVideo=document.getElementById('wallVideo');
const marker=document.getElementById('marker');
const scene=document.querySelector('a-scene');
const tfBadge=document.getElementById('tfBadge');
const btnWall=document.getElementById('btnWall');

let found=false;

/* åš´æ ¼é‹ªæ»¿ï¼šç­‰ MindAR æ’å…¥ .mindar-container å¾Œå†é–ä¸€æ¬¡ï¼ˆå«æ—‹è½‰/å›åˆ°å‰æ™¯ï¼‰ */
function lockMindARContainer(){
  const c=document.querySelector('.mindar-container');
  if(!c) return;
  c.style.position='fixed';
  c.style.inset='0';
  c.style.width='100vw';
  c.style.height='100vh';
  c.style.overflow='hidden';
  // å…§éƒ¨ç¯€é»ä¹Ÿé–ä¸€æ¬¡
  c.querySelectorAll('video,canvas').forEach(el=>{
    el.style.position='absolute';
    el.style.left='0'; el.style.top='0';
    el.style.width='100%'; el.style.height='100%';
  });
}

function tryPlay(){ v.play().catch(()=>{}); }
['loadeddata','canplay'].forEach(ev=>v.addEventListener(ev,tryPlay,{once:true}));
window.addEventListener('pointerdown',tryPlay,{once:true});
window.addEventListener('touchstart',tryPlay,{once:true,passive:true});

document.getElementById('btnStart').onclick=async()=>{
  try{
    statusEl.textContent='è«‹æˆæ¬Šç›¸æ©Ÿâ€¦';
    if(!navigator.mediaDevices?.getUserMedia) throw new Error('ç„¡æ³•å–ç”¨ç›¸æ©Ÿ');
    const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}},audio:false});
    s.getTracks().forEach(t=>t.stop());

    statusEl.textContent='å•Ÿå‹•ä¸­â€¦';
    if(!scene.hasLoaded) await new Promise(r=>scene.addEventListener('loaded',r,{once:true}));
    const arSystem=scene.systems['mindar-image-system']||scene.systems['mindar-image'];
    await arSystem.start();

    // é–å®¹å™¨å°ºå¯¸ï¼ˆå•Ÿå‹•å¾Œ MindAR æœƒæ’å…¥ .mindar-containerï¼‰
    lockMindARContainer();
    window.addEventListener('resize', lockMindARContainer);

    statusEl.textContent='è«‹å°æº–éŒ¨é»';
    log('âœ… AR å·²å•Ÿå‹•');
    v.load(); tryPlay();
  }catch(e){ statusEl.textContent='å•Ÿå‹•å¤±æ•—'; log('ğŸŸ¥ '+e.message); }
};

document.getElementById('btnForcePlay').onclick=()=>{v.play().then(()=>log('â–¶ï¸ æ‰‹å‹•æ’­æ”¾æˆåŠŸ')).catch(e=>log('ğŸŸ¥ '+e.message));};

marker.addEventListener('targetFound',()=>{
  tfBadge.style.display='block';
  log('ğŸ¯ targetFound');
  found=true;
  document.getElementById('testOnMarker').setAttribute('visible','true');
  v.play().catch(()=>{});
  btnWall.disabled=false;
});
marker.addEventListener('targetLost',()=>{tfBadge.style.display='none';});

btnWall.onclick=()=>{
  if(!found) return;
  marker.appendChild(wall);
  // å…ˆç¤ºæ„ 3m å¯¬ï¼Œç¢ºèªè²¼åˆä¸åç§»å¾Œå†æ”¹å› 15.14 Ã— 3.283
  wallVideo.setAttribute('width', 3.0);
  wallVideo.setAttribute('height', 3.0*(3.283/15.14));
  wall.setAttribute('position','0 0 0.01');
  wall.setAttribute('visible','true');
  v.play().catch(()=>{});
  log('ğŸ§± å·²åˆ‡åˆ°å¤§ç‰†ï¼ˆç¤ºæ„ 3m å¯¬ï¼‰ã€‚è‹¥ç©©å®šå†æ”¹å› 15.14 Ã— 3.283ã€‚');
};
</script>
</body>
</html>
