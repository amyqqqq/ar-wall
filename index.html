<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>COLASA WHOCARES ARRRRRR!!!!</title>

<!-- å®˜æ–¹ç‰ˆæœ¬ï¼šA-Frame 1.6.0 + mind-ar 1.2.5 -->
<script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

<style>
  body{
    margin:0;
    overflow:hidden;
    background:#000;
    color:#0f0;
    font-family:monospace;
  }

  /* éš±è—å³ä¸‹è§’ VR æŒ‰éˆ• */
  a-enter-vr-button, .a-enter-vr-button {
    display: none !important;
  }
</style>
</head>
<body>

<a-scene
  mindar-image="imageTargetSrc: ./wall-anchor.mind?v=20251113; autoStart: true; missTolerance: 15"
  color-space="sRGB"
  renderer="colorManagement: true; physicallyCorrectLights: true"
  vr-mode-ui="enabled: false"
  device-orientation-permission-ui="enabled: false">

  <a-assets timeout="30000">
    <video id="vid" src="./video.mp4"
           preload="auto"
           playsinline webkit-playsinline
           muted
           crossorigin="anonymous"></video>
  </a-assets>

  <!-- camera -->
  <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

  <!-- 4 å€‹éŒ¨é»ï¼štargetIndex 0~3ï¼Œéƒ½æ›åŒä¸€æ”¯å½±ç‰‡ -->
  <!-- é€™å€‹ç‰ˆæœ¬ä¸€åµæ¸¬åˆ°éŒ¨é»ï¼Œå°±ç›´æ¥ä»¥ã€Œå¤§ç‰†æ¨¡å¼ã€é¡¯ç¤º -->
  <a-entity id="marker0" class="marker" mindar-image-target="targetIndex: 0">
    <a-plane class="wall-plane"
      position="0 0 0"
      width="0.8" height="0.4"
      material="shader:flat; src:#vid; side:double; transparent:true; alphaTest:0.01">
    </a-plane>
  </a-entity>

  <a-entity id="marker1" class="marker" mindar-image-target="targetIndex: 1">
    <a-plane class="wall-plane"
      position="0 0 0"
      width="0.8" height="0.4"
      material="shader:flat; src:#vid; side:double; transparent:true; alphaTest:0.01">
    </a-plane>
  </a-entity>

  <a-entity id="marker2" class="marker" mindar-image-target="targetIndex: 2">
    <a-plane class="wall-plane"
      position="0 0 0"
      width="0.8" height="0.4"
      material="shader:flat; src:#vid; side:double; transparent:true; alphaTest:0.01">
    </a-plane>
  </a-entity>

  <a-entity id="marker3" class="marker" mindar-image-target="targetIndex: 3">
    <a-plane class="wall-plane"
      position="0 0 0"
      width="0.8" height="0.4"
      material="shader:flat; src:#vid; side:double; transparent:true; alphaTest:0.01">
    </a-plane>
  </a-entity>

</a-scene>

<script>
const v = document.getElementById('vid');

const markers = Array.from(document.querySelectorAll('.marker'));
const planes  = Array.from(document.querySelectorAll('.wall-plane'));

// ğŸ‘‰ åŒä¸€æ™‚é–“åªå…è¨±ä¸€é¡†éŒ¨é»ç•¶ä¸»è§’
let activeMarkerIndex = null;

// ç‰†çš„å¯¦éš›å°ºå¯¸ï¼ˆå…¬å°ºï¼‰
const WALL_W = 15.14;
const WALL_H = 3.283;

// æ¯ä¸€é¡†éŒ¨é»å„è‡ªçš„ã€Œç‰†ä½ç½®å¾®èª¿å€¼ã€
const wallPosList = [
  { x: 3.10,  y: 0.00, z: 0 }, // éŒ¨é» 0
  { x: 1.40,  y: 0.00, z: 0 }, // éŒ¨é» 1
  { x: 0.00,  y: 0.00, z: 0 }, // éŒ¨é» 2
  { x:-3.40,  y: 0.00, z: 0 }  // éŒ¨é» 3
];

// æ¯ä¸€é¡†éŒ¨é»å„è‡ªçš„ã€Œç‰†æ—‹è½‰å¾®èª¿å€¼ã€ï¼ˆè§’åº¦ï¼Œåº¦æ•¸ï¼‰
const wallRotList = [
  { x: 0,   y: 0, z: 0 }, // éŒ¨é» 0
  { x: 0,   y: 0, z: 0 }, // éŒ¨é» 1
  { x: 1.0, y: 0, z: 0 }, // éŒ¨é» 2
  { x: 0,   y: 0, z: 0 }  // éŒ¨é» 3
];

// æ¯ä¸€é¡†éŒ¨é»å„è‡ªçš„ç¸®æ”¾å€ç‡
const wallScaleList = [
  { s: 0.60 }, // éŒ¨é» 0
  { s: 0.60 }, // éŒ¨é» 1
  { s: 0.60 }, // éŒ¨é» 2
  { s: 0.60 }  // éŒ¨é» 3
];

// æ‰‹æ©Ÿäº’å‹•ä¸€æ¬¡çµ¦å½±ç‰‡æ’­æ”¾æ¬Šé™
function tryPlay(){ v.play().catch(()=>{}); }
['loadeddata','canplay'].forEach(ev => v.addEventListener(ev, tryPlay, {once:true}));
window.addEventListener('pointerdown', tryPlay, {once:true});
window.addEventListener('touchstart', tryPlay, {once:true, passive:true});

// å½±ç‰‡æ­£æ’­ â†” åå‘ã€Œæ‰‹å‹•å€’å¸¶ã€ ping-pong å¾ªç’°
let pingpongDirection = 1;   // 1 = æ­£æ’­, -1 = åå‘å€’å¸¶
let reverseTimer = null;

// ä¸€é–‹å§‹å…ˆæ­£æ’­
v.playbackRate = 1;

// æ­£å¸¸å¾€å‰æ’­åˆ°åº• â†’ æ”¹æˆåå‘ã€Œå€’å¸¶ã€
v.addEventListener('ended', () => {
  startReverse();
});

function startForward(){
  pingpongDirection = 1;
  if (reverseTimer){
    clearInterval(reverseTimer);
    reverseTimer = null;
  }
  v.playbackRate = 1;
  if (v.currentTime <= 0){
    v.currentTime = 0.01;
  }
  v.play().catch(()=>{});
}

function startReverse(){
  pingpongDirection = -1;
  if (reverseTimer){
    clearInterval(reverseTimer);
  }
  v.pause();

  if (!isFinite(v.duration) || v.duration === 0){
    return; // é¿å…å½±ç‰‡é‚„æ²’æº–å‚™å¥½
  }

  if (v.currentTime >= v.duration){
    v.currentTime = v.duration - 0.03;
  }

  const step = 1/30; // æ¯æ¬¡å€’å¸¶ 1/30 ç§’ï¼Œå¤§æ¦‚ 30fps
  reverseTimer = setInterval(() => {
    if (v.currentTime <= 0.03){
      // å€’å¸¶å›åˆ°é–‹é ­ â†’ å†æ­£æ’­
      clearInterval(reverseTimer);
      reverseTimer = null;
      startForward();
    } else {
      v.currentTime = Math.max(0, v.currentTime - step);
    }
  }, 33); // æ¯ 33ms æ›´æ–°ä¸€æ¬¡ï¼ˆç´„ 30fpsï¼‰
}

// ç¶å®šæ¯ä¸€é¡†éŒ¨é»çš„äº‹ä»¶
markers.forEach((marker, idx) => {
  const plane = planes[idx];

  marker.addEventListener('targetFound', () => {
    console.log('ğŸ¯ targetFound', idx);

    // â­ æ ¸å¿ƒï¼šå¦‚æœå·²ç¶“æœ‰ä¸€é¡†åœ¨ç”¨ï¼Œè€Œä¸”ä¸æ˜¯é€™ä¸€é¡† â†’ ç›´æ¥å¿½ç•¥
    if (activeMarkerIndex !== null && activeMarkerIndex !== idx) {
      console.log('ğŸ”’ å·²æœ‰æ´»å‹•éŒ¨é» #'+activeMarkerIndex+'ï¼Œå¿½ç•¥ #'+idx);
      return;
    }

    // æ²’æœ‰æ´»å‹•éŒ¨é»æ™‚ï¼Œæ‰è®“é€™ä¸€é¡†ä¸Šä½
    if (activeMarkerIndex === null) {
      activeMarkerIndex = idx;
      console.log('âœ… è¨­å®šæ´»å‹•éŒ¨é» #'+idx);
    }

    // ç›´æ¥ä½¿ç”¨ã€Œå¤§ç‰†æ¨¡å¼ã€å°ºå¯¸
    plane.setAttribute('width',  WALL_W);
    plane.setAttribute('height', WALL_H);

    const pPos   = wallPosList[idx];
    const pRot   = wallRotList[idx];
    const pScale = wallScaleList[idx].s;

    plane.setAttribute('position', `${pPos.x} ${pPos.y} ${pPos.z}`);
    plane.setAttribute('rotation', `${pRot.x} ${pRot.y} ${pRot.z}`);
    plane.object3D.scale.set(pScale, pScale, pScale);

    // åªé¡¯ç¤ºæ´»å‹•éŒ¨é»çš„ plane
    planes.forEach((p, i) => {
      p.object3D.visible = (i === idx);
    });

    v.play().catch(()=>{});
  });

  marker.addEventListener('targetLost', () => {
    console.log('âš  targetLost', idx);

    // å¦‚æœé€™é¡†ä¸æ˜¯æ­£åœ¨ç”¨çš„é‚£ä¸€é¡† â†’ å¿½ç•¥
    if (activeMarkerIndex !== idx) {
      console.log('å¿½ç•¥éæ´»å‹•éŒ¨é» targetLost #'+idx);
      return;
    }

    plane.object3D.visible = false;

    // æŠŠã€Œæ´»å‹•éŒ¨é»ã€æ¸…æ‰ï¼Œè®“ä¸‹ä¸€é¡†å¯ä»¥æ¥æ‰‹
    activeMarkerIndex = null;
  });
});
</script>
</body>
</html>
