<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>å¤§ç‰† ARï½œå–®éŒ¨é–å®šï¼‹æ ¡æ­£</title>
<script src="https://unpkg.com/aframe@1.4.2/dist/aframe.min.js"></script>
<script src="https://unpkg.com/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
<style>
  html,body{margin:0;height:100%;background:#000;color:#0f0;font-family:monospace}
  #top{position:fixed;left:8px;top:8px;z-index:20}
  #log{position:fixed;left:8px;bottom:8px;right:8px;height:120px;overflow:auto;
       background:rgba(0,0,0,.5);padding:8px;z-index:20;font-size:12px}
  #ctrl{position:fixed;left:8px;bottom:140px;z-index:20;background:rgba(0,0,0,.5);
        border-radius:10px;padding:8px;display:none}
  #ctrl button{margin:2px 3px;padding:8px 12px}
  .row{margin:4px 0}
</style>
</head>
<body>
<div id="top">
  <button id="btnStart">å•Ÿå‹• AR</button>
  <span id="status">æœªå•Ÿå‹•</span>
</div>

<div id="ctrl">
  <div class="row">
    ä½ç½®ï¼š<button onclick="nudge(-step,0)">â†</button>
    <button onclick="nudge(step,0)">â†’</button>
    <button onclick="nudge(0,step)">â†‘</button>
    <button onclick="nudge(0,-step)">â†“</button>
  </div>
  <div class="row">
    æ—‹è½‰Zï¼š<button onclick="rot(-rotStep)">â†º</button>
    <button onclick="rot(rotStep)">â†»</button>
  </div>
  <div class="row">
    å°ºå¯¸ï¼š<button onclick="scaleMul(0.98)">ç¸®å°</button>
    <button onclick="scaleMul(1.02)">æ”¾å¤§</button>
  </div>
  <div class="row">
    ç²¾åº¦ï¼š
    <button onclick="setFine()">ç´°</button>
    <button onclick="setCoarse()">ç²—</button>
    <button onclick="resetAdj()">é‡ç½®å¾®èª¿</button>
    <button onclick="saveCfg()">ğŸ’¾ å„²å­˜</button>
    <button onclick="reload()">é‡æ–°è¼‰å…¥</button>
  </div>
</div>

<div id="log"></div>

<a-scene
  embedded
  color-space="sRGB"
  vr-mode-ui="enabled:false"
  device-orientation-permission-ui="enabled:false"
  mindar-image="imageTargetSrc: ./wall-anchor.mind; autoStart: false; maxTrack: 1;">
  <a-assets>
    <video id="vid" src="./video.mp4" loop playsinline webkit-playsinline muted preload="auto" crossorigin="anonymous"></video>
  </a-assets>

  <!-- å–®ä¸€éŒ¨é»ï¼ˆå·¦æ®µä¸­é–“é‚£å¡Šåœ–æ¡ˆï¼‰ -->
  <a-entity id="marker" mindar-image-target="targetIndex: 0"></a-entity>

  <!-- é–å®šå¾Œçš„ç‰†é¢å½±ç‰‡ï¼ˆä¸æ›åœ¨ marker ä¸‹ï¼‰ -->
  <a-entity id="wallPlane" visible="false">
    <!-- ç‰†å¯¬ 15.14mï¼›å½±ç‰‡é«˜ä¾ 3840x832 æ¯”ä¾‹ = 3.283m -->
    <a-video id="wallVideo" src="#vid" width="15.14" height="3.283"
             material="shader: flat; side: double;" position="0 0 0"></a-video>
  </a-entity>

  <a-entity camera></a-entity>
</a-scene>

<script>
const logEl = document.getElementById('log');
const log = s=>{console.log(s); logEl.textContent += s+"\n"; logEl.scrollTop = logEl.scrollHeight;}
const statusEl = document.getElementById('status');
const btnStart = document.getElementById('btnStart');
const ctrl = document.getElementById('ctrl');

const scene = document.querySelector('a-scene');
const marker = document.getElementById('marker');
const wall   = document.getElementById('wallPlane');
const video  = document.getElementById('vid');

let locked = false;

/* ===== ç‰†èˆ‡éŒ¨é»å¹¾ä½•è¨­å®šï¼ˆå¯ä¾ç¾å ´æ”¹ï¼‰ ===== */
const WALL_W = 15.14;     // ç‰†å¯¬ï¼ˆå…¬å°ºï¼‰
const WALL_H = 3.283;     // å½±ç‰‡é«˜ï¼ˆå…¬å°ºï¼‰â€”ä¾ 3840x832 æ¯”ä¾‹ç®—å‡º
// éŒ¨é»åœ¨ç‰†ã€Œå·¦ä¸‹è§’ã€åº§æ¨™ç³»ä¸­çš„ä½ç½®ï¼ˆå…¬å°ºï¼‰â€”ä½ çš„åœ–ç¤ºï¼šå·¦ 1.73 mã€ä¸Š 0.46 m â†’ ç›¸å°å·¦ä¸‹è§’æ˜¯ (1.73, 0.46)
const ANCHOR_X = 1.73;
const ANCHOR_Y = 0.46;

/* ===== ç¾å ´å¾®èª¿ï¼ˆå­˜ localStorageï¼‰ ===== */
const LS_KEY = 'WALL_AR_LOCK_V2';
let adj = JSON.parse(localStorage.getItem(LS_KEY) || '{"ox":0,"oy":0,"rz":0,"s":1}');
let step = 0.05, rotStep = 1.5;   // åˆå§‹ç‚ºã€Œç´°ã€ï¼›å¯åˆ‡æ›ç²—

function applyAdj(){
  // ä½ç½®å¾®èª¿ï¼ˆæ²¿è‘—å½±ç‰‡å±€éƒ¨åº§æ¨™çš„å³èˆ‡ä¸Šï¼‰
  const q = wall.object3D.quaternion;
  const right = new THREE.Vector3(1,0,0).applyQuaternion(q);
  const up    = new THREE.Vector3(0,1,0).applyQuaternion(q);
  // å…ˆç§»å›åŸºæº–ï¼ˆé–å®šæ™‚çš„ä¸­å¿ƒï¼‰ï¼Œå†ç–ŠåŠ å¾®èª¿
  wall.object3D.position.addScaledVector(right, adj.ox);
  wall.object3D.position.addScaledVector(up,    adj.oy);
  wall.object3D.rotateZ(THREE.MathUtils.degToRad(adj.rz));
  wall.object3D.scale.multiplyScalar(adj.s);
}
function nudge(dx,dy){ adj.ox += dx; adj.oy += dy; applyResetPose(); }
function rot(d){ adj.rz += d; applyResetPose(); }
function scaleMul(m){ adj.s *= m; applyResetPose(); }
function setFine(){ step=0.02; rotStep=0.8; log('ç²¾åº¦=ç´°'); }
function setCoarse(){ step=0.10; rotStep=3; log('ç²¾åº¦=ç²—'); }
function saveCfg(){ localStorage.setItem(LS_KEY, JSON.stringify(adj)); log('å·²å„²å­˜è¨­å®šï¼š'+JSON.stringify(adj)); }
function resetAdj(){ adj={ox:0,oy:0,rz:0,s:1}; applyResetPose(); log('å·²é‡ç½®å¾®èª¿'); }
function reload(){ location.reload(); }

/* é‡æ–°å¥—ç”¨ï¼šå…ˆå›åˆ°é–å®šåŸºæº–ä½å§¿ï¼Œå†å¥— adj */
function applyResetPose(){
  if(!basePose) return;
  wall.object3D.position.copy(basePose.pos);
  wall.object3D.quaternion.copy(basePose.quat);
  wall.object3D.scale.copy(basePose.scl);
  applyAdj();
}

/* ===== é–å®šï¼šå¾éŒ¨é»æ¨å›ç‰†ä¸­å¿ƒ ===== */
let basePose = null; // {pos, quat, scl}
scene.addEventListener('targetFound', ()=>{
  if(locked) return;
  log('æ‰¾åˆ°éŒ¨é» â†’ å–å¾—ä½å§¿ä¸¦é–å®š');
  video.play().catch(()=>{});

  // 1) ç”¨éŒ¨é»ç•¶ä¸‹çš„ä¸–ç•ŒçŸ©é™£åˆå§‹åŒ– wall
  const m = marker.object3D.matrixWorld.clone();
  wall.object3D.matrix.copy(m);
  wall.object3D.matrix.decompose(wall.object3D.position, wall.object3D.quaternion, wall.object3D.scale);

  // 2) è®“ wall çš„å°ºå¯¸ä»¥ <a-video> çš„ width/height ç‚ºä¸»ï¼ˆä¸å†ç­‰æ¯”ç¸®æ”¾ï¼‰
  wall.object3D.scale.set(1,1,1);

  // 3) ç”±éŒ¨é»æ¨å›ã€Œå½±ç‰‡å¹³é¢ä¸­å¿ƒã€çš„ä½ç½®ï¼ˆæ²¿è‘— wall çš„å±€éƒ¨è»¸ï¼‰
  //    ä¸­å¿ƒä½æ–¼( W/2, H/2 )ï¼›éŒ¨é»ä½æ–¼( ANCHOR_X, ANCHOR_Y )
  const dx = (WALL_W/2 - ANCHOR_X);     // å³ç‚º +X
  const dy = (ANCHOR_Y - WALL_H/2);     // ä¸Šç‚º +Yï¼ˆæ‰€ä»¥éŒ¨é»åœ¨ä¸‹æ–¹æ™‚ç‚ºè² ï¼‰
  const q = wall.object3D.quaternion;
  const right = new THREE.Vector3(1,0,0).applyQuaternion(q);
  const up    = new THREE.Vector3(0,1,0).applyQuaternion(q);
  wall.object3D.position.addScaledVector(right, dx);
  wall.object3D.position.addScaledVector(up,    dy);

  wall.setAttribute('visible','true');
  locked = true;
  statusEl.textContent = 'å·²é–å®šï¼Œå¯æ ¡æ­£ä¸¦å„²å­˜';

  // è¨˜éŒ„é–å®šçš„åŸºæº–ä½å§¿ï¼ˆä¹‹å¾Œæ¯æ¬¡å¾®èª¿éƒ½å¾æ­¤é‚„åŸå†å¥— adjï¼‰
  basePose = {
    pos:  wall.object3D.position.clone(),
    quat: wall.object3D.quaternion.clone(),
    scl:  wall.object3D.scale.clone()
  };

  // å¥—ç”¨å·²ä¿å­˜çš„å¾®èª¿
  applyAdj();
  ctrl.style.display = 'block';
});

btnStart.onclick = async ()=>{
  try{
    await scene.systems['mindar-image'].start();
    statusEl.textContent = 'è«‹å°æº–éŒ¨é»ï¼ˆå·¦æ®µä¸­é–“é‚£å¡Šåœ–æ¡ˆï¼‰';
    log('AR å·²å•Ÿå‹•');
  }catch(e){
    statusEl.textContent = 'å•Ÿå‹•å¤±æ•—';
    log('å•Ÿå‹•å¤±æ•—ï¼š'+e);
  }
};

scene.addEventListener('loaded', ()=>{
  log('å°±ç·’ï¼šæŒ‰ã€Œå•Ÿå‹• ARã€ï¼ŒæƒéŒ¨é» â†’ è‡ªå‹•é–å®š â†’ ç”¨é¢æ¿å¾®èª¿ã€å„²å­˜ã€‚');
  setFine();
});
</script>
</body>
</html>
