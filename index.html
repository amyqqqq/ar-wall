<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>å¤§ç‰† ARï½œéŒ¨é»žè¨ºæ–·ç‰ˆ</title>

<!-- A-Frame + MindAR -->
<script src="https://unpkg.com/aframe@1.4.2/dist/aframe.min.js"></script>
<script src="https://unpkg.com/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

<style>
  *{box-sizing:border-box}
  html,body{
    margin:0;
    height:100%;
    background:#000;
    color:#0f0;
    font-family:monospace;
  }
  body{position:fixed; inset:0; overflow:hidden;}

  #top{
    position:fixed;
    left:8px;
    top:8px;
    z-index:100003;
    display:flex;
    gap:6px;
    align-items:center;
    flex-wrap:wrap;
  }
  #top button{padding:6px 10px;font-size:13px}
  #status{background:#000a;padding:4px 8px;border-radius:6px}

  #log{
    position:fixed;
    left:8px;
    bottom:8px;
    right:8px;
    height:120px;
    overflow:auto;
    background:rgba(0,0,0,.55);
    padding:8px;
    z-index:100003;
    font-size:11px;
    line-height:1.25;
  }

  #tfBadge{
    position:fixed;
    right:12px;
    top:40px;
    z-index:100003;
    background:#29b6f6;
    color:#000;
    padding:6px 10px;
    border-radius:8px;
    display:none;
    font-weight:bold;
  }

  .mindar-container{
    position:fixed !important;
    inset:0 !important;
    width:100vw !important;
    height:100vh !important;
    overflow:hidden !important;
    touch-action:none !important;
  }
  .mindar-container video,
  .mindar-container canvas{
    position:absolute !important;
    left:0 !important;
    top:0 !important;
    width:100% !important;
    height:100% !important;
  }
  .mindar-container video{
    object-fit:fill !important;
    transform:none !important;
  }

  .mindar-ui-loading,
  .mindar-ui-scanning{display:none !important;}
</style>
</head>
<body>
<div id="tfBadge">ðŸŽ¯ target: -</div>
<div id="top">
  <button id="btnStart">å•Ÿå‹• AR</button>
  <button id="btnVideoTest">å½±ç‰‡æ¸¬è©¦</button>
  <span id="status">æœªå•Ÿå‹•</span>
</div>
<div id="log"></div>

<a-scene
  color-space="sRGB"
  vr-mode-ui="enabled:false"
  device-orientation-permission-ui="enabled:false"
  mindar-image="imageTargetSrc: ./wall-anchor.mind?v=1113; autoStart: false; maxTrack: 2"
  renderer="alpha:true; colorManagement:true; physicallyCorrectLights:true">

  <a-assets timeout="30000">
    <video id="vid" src="./video.mp4" preload="auto"
      playsinline webkit-playsinline muted crossorigin="anonymous"></video>
  </a-assets>

  <!-- marker 0 -->
  <a-entity id="marker0" mindar-image-target="targetIndex:0">
    <a-plane id="plane0" position="0 0 0.01" width="0.8" height="0.4"
      material="shader:flat; src:#vid; side:double; transparent:true; alphaTest:0.01"
      visible="false"></a-plane>
  </a-entity>

  <!-- marker 1ï¼ˆå¦‚æžœ .mind è£¡æœ‰ç¬¬äºŒå¼µåœ–ï¼Œå°±çœ‹é€™è£¡æœƒä¸æœƒåµæ¸¬åˆ°ï¼‰ -->
  <a-entity id="marker1" mindar-image-target="targetIndex:1">
    <a-plane id="plane1" position="0 0 0.01" width="0.8" height="0.4"
      material="shader:flat; src:#vid; side:double; transparent:true; alphaTest:0.01"
      visible="false"></a-plane>
  </a-entity>

  <!-- camera + debug å¹³é¢ï¼ˆå½±ç‰‡æ¸¬è©¦ç”¨ï¼‰ -->
  <a-entity camera="facingMode: environment" id="camRig">
    <a-plane id="debugPlane" position="0 0 -1"
      width="4" height="2"
      material="color:#202020; side:double"
      visible="false"></a-plane>
  </a-entity>

</a-scene>

<script>
const logEl=document.getElementById('log');
const log=s=>{console.log(s);logEl.textContent+=s+"\n";logEl.scrollTop=logEl.scrollHeight;}

const statusEl=document.getElementById('status');
const tfBadge=document.getElementById('tfBadge');
const v=document.getElementById('vid');
const scene=document.querySelector('a-scene');
const debugPlane=document.getElementById('debugPlane');

const marker0=document.getElementById('marker0');
const marker1=document.getElementById('marker1');
const plane0=document.getElementById('plane0');
const plane1=document.getElementById('plane1');

function lockMindARContainer(){
  const c=document.querySelector('.mindar-container');
  if(!c) return;
  c.style.position='fixed';
  c.style.inset='0';
  c.style.width='100vw';
  c.style.height='100vh';
  c.style.overflow='hidden';
  c.querySelectorAll('video,canvas').forEach(el=>{
    el.style.position='absolute';
    el.style.left='0';
    el.style.top='0';
    el.style.width='100%';
    el.style.height='100%';
  });
}

// é»žä¸€ä¸‹å°±è©¦è‘—æ’­æ”¾å½±ç‰‡ï¼ˆfor iOSï¼‰
function tryPlay(){ v.play().catch(()=>{}); }
['loadeddata','canplay'].forEach(ev=>v.addEventListener(ev,tryPlay,{once:true}));
window.addEventListener('pointerdown',tryPlay,{once:true});
window.addEventListener('touchstart',tryPlay,{once:true,passive:true});

document.getElementById('btnStart').onclick=async()=>{
  try{
    statusEl.textContent='è«‹æŽˆæ¬Šç›¸æ©Ÿâ€¦';
    if(!navigator.mediaDevices?.getUserMedia) throw new Error('ç„¡æ³•å–ç”¨ç›¸æ©Ÿ');
    const s=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:'environment'}},
      audio:false
    });
    s.getTracks().forEach(t=>t.stop());

    statusEl.textContent='å•Ÿå‹•ä¸­â€¦';
    if(!scene.hasLoaded){
      await new Promise(r=>scene.addEventListener('loaded',r,{once:true}));
    }
    const arSystem=scene.systems['mindar-image-system'] || scene.systems['mindar-image'];

    scene.addEventListener('arReady',()=>log('âœ… arReady'),{once:true});
    scene.addEventListener('arError',e=>log('ðŸŸ¥ arError: '+e.detail));

    await arSystem.start();
    lockMindARContainer();
    window.addEventListener('resize', lockMindARContainer);

    statusEl.textContent='è«‹å°æº–éŒ¨é»ž';
    log('âœ… AR å·²å•Ÿå‹•ï¼ˆéŒ¨é»žè¨ºæ–·ç‰ˆï¼‰');
    v.load(); tryPlay();
  }catch(e){
    statusEl.textContent='å•Ÿå‹•å¤±æ•—';
    log('ðŸŸ¥ '+e.message);
  }
};

document.getElementById('btnVideoTest').onclick=()=>{
  debugPlane.setAttribute(
    'material',
    'shader:flat; src:#vid; side:double; transparent:true; alphaTest:0.01'
  );
  debugPlane.setAttribute('visible','true');
  v.play().then(()=>log('ðŸŽ¬ å½±ç‰‡æ¸¬è©¦ï¼šä¸­å¤®å¹³é¢å·²è²¼å½±ç‰‡'))
          .catch(e=>log('ðŸŸ¥ å½±ç‰‡æ’­æ”¾éŒ¯èª¤ï¼š'+e.message));
};

/* marker 0 äº‹ä»¶ */
marker0.addEventListener('targetFound',()=>{
  tfBadge.style.display='block';
  tfBadge.textContent='ðŸŽ¯ target: 0';
  log('ðŸŽ¯ targetFound: index 0');
  plane0.setAttribute('visible','true');
  v.play().catch(()=>{});
});
marker0.addEventListener('targetLost',()=>{
  log('âš  targetLost: index 0');
});

/* marker 1 äº‹ä»¶ */
marker1.addEventListener('targetFound',()=>{
  tfBadge.style.display='block';
  tfBadge.textContent='ðŸŽ¯ target: 1';
  log('ðŸŽ¯ targetFound: index 1');
  plane1.setAttribute('visible','true');
  v.play().catch(()=>{});
});
marker1.addEventListener('targetLost',()=>{
  log('âš  targetLost: index 1');
});
</script>
</body>
</html>
