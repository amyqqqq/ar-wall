<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>å¤§ç‰† ARï½œå–®éŒ¨é–å®šï¼‹æ ¡æ­£ï¼ˆå®Œæ•´æ•´åˆï¼‹Blobä¿å‘½ï¼‰</title>

<!-- A-Frame + MindARï¼ˆé †åºå¾ˆé‡è¦ï¼‰ -->
<script src="https://unpkg.com/aframe@1.4.2/dist/aframe.min.js"></script>
<script src="https://unpkg.com/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

<style>
  html,body{margin:0;height:100%;background:#000;color:#0f0;font-family:monospace;overflow:hidden;}
  a-scene{position:fixed !important;inset:0 !important;width:100vw !important;height:100vh !important;z-index:1;}
  canvas.a-canvas{width:100vw !important;height:100vh !important;background:transparent !important;pointer-events:none !important;z-index:1;}
  #bgCam{position:fixed;left:0;top:0;width:100vw;height:100vh;object-fit:cover;z-index:0;display:block;opacity:1;transform:none !important;}
  .mindar-ui-loading,.mindar-ui-scanning{display:none !important;}
  #top{position:fixed;left:8px;top:8px;z-index:10;}
  #log{position:fixed;left:8px;bottom:8px;right:8px;height:140px;overflow:auto;background:rgba(0,0,0,.55);padding:8px;z-index:10;font-size:12px;line-height:1.25;}
  #ctrl{position:fixed;left:8px;bottom:160px;z-index:10;background:rgba(0,0,0,.5);border-radius:10px;padding:8px;display:block;}
  #ctrl button{margin:2px 3px;padding:8px 12px;}
  .row{margin:4px 0;}
  #anchorGhost{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);max-width:min(80vw,80vh);height:auto;opacity:0.35;z-index:9;pointer-events:none;display:none;filter:drop-shadow(0 0 4px rgba(0,0,0,.4));transition:opacity .25s ease;}
  #recDot{position:fixed;right:12px;top:12px;width:12px;height:12px;background:#f33;border-radius:50%;box-shadow:0 0 10px rgba(255,51,51,0.67);z-index:12;display:none;}
  #tfBadge{position:fixed;right:12px;top:40px;z-index:12;background:#f33;color:#fff;padding:6px 10px;border-radius:8px;display:none;font-weight:bold;}
  /* è¨ºæ–·é¢æ¿ */
  #diag{position:fixed;right:8px;bottom:8px;z-index:9999;background:#000a;color:#fff;padding:8px;border-radius:8px;max-width:70vw;font:12px monospace}
  #nativeV{display:none;position:fixed;inset:0;z-index:10000;width:100vw;height:100vh;object-fit:contain;background:#000}
</style>
</head>
<body>
<video id="bgCam" autoplay muted playsinline webkit-playsinline></video>

<img id="anchorGhost" src="./anchor.png" alt="éŒ¨é»å°é½Šé è¦½"/>
<div id="recDot"></div>
<div id="tfBadge">ğŸ¯ targetFound</div>

<div id="top">
  <button id="btnStart">å•Ÿå‹• AR</button>
  <button id="btnForcePlay">â–¶ æ’­æ”¾å½±ç‰‡</button>
  <span id="status">æœªå•Ÿå‹•</span>
</div>

<div id="ctrl">
  <div class="row">
    ä½ç½®ï¼š<button onclick="nudge(-step,0)">â†</button><button onclick="nudge(step,0)">â†’</button>
    <button onclick="nudge(0,step)">â†‘</button><button onclick="nudge(0,-step)">â†“</button>
  </div>
  <div class="row">æ—‹è½‰Zï¼š<button onclick="rot(-rotStep)">â†º</button><button onclick="rot(rotStep)">â†»</button></div>
  <div class="row">å°ºå¯¸ï¼š<button onclick="scaleMul(0.98)">ç¸®å°</button><button onclick="scaleMul(1.02)">æ”¾å¤§</button></div>
  <div class="row">
    ç²¾åº¦ï¼š<button onclick="setFine()">ç´°</button><button onclick="setCoarse()">ç²—</button>
    <button onclick="resetAdj()">é‡ç½®å¾®èª¿</button><button onclick="saveCfg()">ğŸ’¾ å„²å­˜</button><button onclick="reload()">é‡æ–°è¼‰å…¥</button>
  </div>
  <div class="row">
    éŒ¨é»åœ–ï¼š<button onclick="toggleGhost()">é¡¯/éš±</button>
    é€æ˜åº¦ <input id="ghostAlpha" type="range" min="0" max="1" step="0.01" value="0.35" oninput="setGhostAlpha(this.value)" style="vertical-align:middle;width:120px">
  </div>
  <div class="row">
    å½±åƒï¼š<button onclick="snap()">ğŸ“¸ æ‹ç…§</button>
    <button id="btnRec" onclick="toggleRec()">âº é–‹å§‹éŒ„å½±</button>
  </div>
</div>

<div id="log"></div>

<!-- è¨ºæ–·é¢æ¿ + åŸç”Ÿæ’­æ”¾ -->
<div id="diag">
  <div>è¨ºæ–·ï¼š<span id="dstat">æœªé–‹å§‹</span></div>
  <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">
    <button id="dPlay">åŸç”Ÿæ’­æ”¾</button>
    <button id="dClose" style="display:none">é—œé–‰åŸç”Ÿ</button>
  </div>
  <div id="dlog" style="margin-top:6px;max-height:28vh;overflow:auto;white-space:pre-wrap"></div>
</div>
<video id="nativeV" playsinline webkit-playsinline controls muted></video>

<a-scene
  embedded color-space="sRGB"
  vr-mode-ui="enabled:false"
  device-orientation-permission-ui="enabled:false"
  mindar-image="imageTargetSrc: ./wall-anchor.mind; autoStart: false; maxTrack: 1;"
  renderer="alpha:true; colorManagement:true; physicallyCorrectLights:true">

  <a-assets timeout="30000">
    <!-- åŠ  controls æ–¹ä¾¿ä½ ç¢ºèªåŸç”Ÿå¯å¦ç›´æ¥æ’­ï¼›æ­£å¼å¯ç§»é™¤ controls -->
    <video id="vid" src="./video.mp4"
      autoplay loop playsinline webkit-playsinline muted preload="auto" controls
      x-webkit-airplay="deny" controlslist="nodownload noplaybackrate"
      crossorigin="anonymous"></video>
  </a-assets>

  <a-entity id="marker" mindar-image-target="targetIndex:0">
    <!-- å°æ¸¬è©¦ç‰‡ -->
    <a-plane id="testOnMarker" position="0 0 0.01" width="0.6" height="0.13"
      material="shader:flat; src:#vid; side:double; transparent:true; alphaTest:0.01"
      visible="true"></a-plane>
  </a-entity>

  <a-entity id="wallPlane" visible="false">
    <!-- ç‰†é¢å¤§ç•«é¢ -->
    <a-plane id="wallVideo" width="15.14" height="3.283" position="0 0 0"
      material="shader:flat; src:#vid; side:double; transparent:true; alphaTest:0.01"></a-plane>
  </a-entity>

  <a-entity camera="facingMode: environment"></a-entity>
</a-scene>

<script>
/* ========= å½±ç‰‡è²¼åœ–é€£çºŒåˆ·æ–°å…ƒä»¶ ========= */
AFRAME.registerComponent('video-texture-tick', {
  schema: { src: {type:'selector'} },
  init() {
    this.video = this.data.src || document.querySelector('#vid');
    this.mesh = null;
    this.bind = () => {
      const m = this.el.getObject3D('mesh'); if(!m) return;
      this.mesh = m;
      const mat = m.material;
      if (mat && mat.map) { mat.map.image = this.video; mat.map.needsUpdate = true; mat.needsUpdate = true; }
    };
    this.el.addEventListener('model-loaded', this.bind);
    this.bind();
  },
  tick() {
    if (!this.mesh || !this.video) return;
    if (this.video.readyState >= 2) {
      const mat = this.mesh.material;
      if (mat && mat.map) mat.map.needsUpdate = true;
    }
  }
});
// æ›åˆ°å…©å€‹å¹³é¢
window.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('wallVideo')?.setAttribute('video-texture-tick','src:#vid');
  document.getElementById('testOnMarker')?.setAttribute('video-texture-tick','src:#vid');
});

const logEl=document.getElementById('log');
const log=s=>{console.log(s);logEl.textContent+=s+"\n";logEl.scrollTop=logEl.scrollHeight;}
const statusEl=document.getElementById('status');
const btnStart=document.getElementById('btnStart');
const btnForcePlay=document.getElementById('btnForcePlay');
const ctrl=document.getElementById('ctrl');
const scene=document.querySelector('a-scene');
const marker=document.getElementById('marker');
const wall=document.getElementById('wallPlane');
const wallPlaneEl=document.getElementById('wallVideo');
const testOnMarker=document.getElementById('testOnMarker');
const videoEl=document.getElementById('vid');
const bgCam=document.getElementById('bgCam');
const ghost=document.getElementById('anchorGhost');
const recDot=document.getElementById('recDot');
const tfBadge=document.getElementById('tfBadge');
let locked=false;

/* å¹¾ä½•ï¼ˆä¾ç‰†é¢èˆ‡éŒ¨é»ç›¸å°ä½ç½®èª¿æ•´ï¼‰ */
const WALL_W=15.14,WALL_H=3.283,ANCHOR_X=1.73,ANCHOR_Y=0.46;

/* å¾®èª¿/å„²å­˜ */
const LS_KEY='WALL_AR_LOCK_V3';
let adj=JSON.parse(localStorage.getItem(LS_KEY)||'{"ox":0,"oy":0,"rz":0,"s":1}');
let step=0.02,rotStep=0.8,basePose=null;

/* â€”â€” æè³ªä¿éšªåˆ·æ–° â€”â€” */
function forceVideoMaterialRefresh(){
  const mesh = wallPlaneEl.getObject3D('mesh');
  if(mesh && mesh.material){
    const mat = mesh.material;
    if(mat.map && mat.map.image !== videoEl){ mat.map.image = videoEl; }
    if(mat.map){ mat.map.needsUpdate = true; }
    mat.needsUpdate = true;
    log('ğŸ§© material.needsUpdate=true');
  }
  const mesh2 = testOnMarker.getObject3D('mesh');
  if(mesh2 && mesh2.material){
    if(mesh2.material.map){ mesh2.material.map.needsUpdate = true; }
    mesh2.material.needsUpdate = true;
  }
}

/* â€”â€” é€£çºŒå˜—è©¦æ’­æ”¾ â€”â€” */
function tryPlayVideoChain(){
  const tryPlay=()=>videoEl.play().catch(()=>{});
  tryPlay();
  videoEl.addEventListener('loadeddata',()=>{tryPlay(); forceVideoMaterialRefresh();},{once:true});
  videoEl.addEventListener('canplay',   ()=>{tryPlay(); forceVideoMaterialRefresh();},{once:true});
  videoEl.addEventListener('playing',   ()=>{log('ğŸï¸ å½±ç‰‡ playing'); forceVideoMaterialRefresh();},{once:true});
  setTimeout(()=>{ if(videoEl.readyState<2){ videoEl.load(); tryPlay(); } forceVideoMaterialRefresh(); }, 400);
}

/* â€”â€” ä½å§¿å¾®èª¿ â€”â€” */
function applyResetPose(){
  if(!basePose)return;
  wall.object3D.position.copy(basePose.pos);
  wall.object3D.quaternion.copy(basePose.quat);
  wall.object3D.scale.copy(basePose.scl);
  const q=wall.object3D.quaternion;
  const right=new THREE.Vector3(1,0,0).applyQuaternion(q);
  const up=new THREE.Vector3(0,1,0).applyQuaternion(q);
  wall.object3D.position.addScaledVector(right,adj.ox);
  wall.object3D.position.addScaledVector(up,adj.oy);
  wall.object3D.rotateZ(THREE.MathUtils.degToRad(adj.rz));
  wall.object3D.scale.multiplyScalar(adj.s);
}
function nudge(dx,dy){adj.ox+=dx;adj.oy+=dy;applyResetPose();}
function rot(d){adj.rz+=d;applyResetPose();}
function scaleMul(m){adj.s*=m;applyResetPose();}
function setFine(){step=0.02;rotStep=0.8;log('ç²¾åº¦=ç´°');}
function setCoarse(){step=0.10;rotStep=3;log('ç²¾åº¦=ç²—');}
function saveCfg(){localStorage.setItem(LS_KEY,JSON.stringify(adj));log('å·²å„²å­˜è¨­å®šï¼š'+JSON.stringify(adj));}
function resetAdj(){adj={ox:0,oy:0,rz:0,s:1};applyResetPose();log('å·²é‡ç½®å¾®èª¿');}
function reload(){location.reload();}

/* â€”â€” å•Ÿå‹• â€”â€” */
async function waitSceneLoaded(el){if(el.hasLoaded)return;await new Promise(r=>el.addEventListener('loaded',r,{once:true}));}
async function ensureCam(){
  if(!navigator.mediaDevices?.getUserMedia)throw new Error('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ getUserMedia');
  const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}},audio:false});
  s.getTracks().forEach(t=>t.stop());
}

btnStart.onclick=async()=>{
  try{
    statusEl.textContent='è«‹æˆæ¬Šç›¸æ©Ÿâ€¦';
    await ensureCam();
    statusEl.textContent='å•Ÿå‹•ä¸­â€¦';
    await waitSceneLoaded(scene);

    const arSystem=scene.systems['mindar-image-system']||scene.systems['mindar-image']||(scene.components['mindar-image']?.system);
    if(!arSystem?.start){statusEl.textContent='å•Ÿå‹•å¤±æ•—ï¼ˆMindAR æœªåˆå§‹åŒ–ï¼‰';log('ğŸŸ¥ MindAR system not ready');return;}

    await arSystem.start();
    statusEl.textContent='è«‹å°æº–éŒ¨é»';
    log('âœ… AR å·²å•Ÿå‹•ï¼Œç­‰å¾… targetFoundâ€¦');

    // è¤‡è£½ä¸²æµåˆ° #bgCam
    if(arSystem.video && arSystem.video.srcObject){
      try{ bgCam.muted=true; bgCam.playsInline=true; bgCam.srcObject=arSystem.video.srcObject; bgCam.play().catch(()=>{}); }
      catch(e){log('ğŸŸ¥ è¤‡è£½ç›¸æ©Ÿä¸²æµå¤±æ•—ï¼š'+e.message);}
    }
    bgCam.addEventListener('loadedmetadata',()=>{log(`ğŸ“· ç›¸æ©Ÿå•Ÿå‹•ï¼š${bgCam.videoWidth}x${bgCam.videoHeight}`);});

    // å½±ç‰‡æš–æ©Ÿ
    videoEl.muted=true; videoEl.playsInline=true; videoEl.load();
    tryPlayVideoChain();

    // 2 ç§’æœªé–å®šï¼šé¡¯ç¤ºç‰†é¢ï¼‹å†è©¦æ’­
    setTimeout(()=>{
      if(!locked){
        wall.setAttribute('visible','true');
        tryPlayVideoChain();
        log('ğŸ§ª åµéŒ¯ï¼š2ç§’æœª targetFoundï¼Œå…ˆé¡¯ç¤ºè¦†å±¤/å˜—è©¦æ’­æ”¾');
      }
    },2000);

    ghost.style.display='block';

  }catch(e){
    statusEl.textContent='å•Ÿå‹•å¤±æ•—';
    log('ğŸŸ¥ å•Ÿå‹•å¤±æ•—ï¼š'+e.name+' / '+e.message);
  }
};

/* â€”â€” æ‰‹å‹•æ’­æ”¾ä¿åº• â€”â€” */
btnForcePlay.onclick=()=>{
  try{
    videoEl.play().then(()=>{
      log('â–¶ï¸ ä½¿ç”¨è€…æ‰‹å‹¢æ’­æ”¾æˆåŠŸ');
      forceVideoMaterialRefresh();
    }).catch(err=>{
      log('ğŸŸ¥ æ‰‹å‹•æ’­æ”¾ä»å¤±æ•—ï¼š'+err.name+' / '+err.message);
    });
  }catch(e){log('ğŸŸ¥ æ‰‹å‹•æ’­æ”¾éŒ¯èª¤ï¼š'+e.message);}
};

/* â€”â€” target äº‹ä»¶ â€”â€” */
marker.addEventListener('targetFound',()=>{
  log('ğŸ¯ æ‰¾åˆ°éŒ¨é» â†’ é–å®šä½å§¿');
  tfBadge.style.display='block';

  tryPlayVideoChain();

  const m=marker.object3D.matrixWorld.clone();
  wall.object3D.matrix.copy(m);
  wall.object3D.matrix.decompose(
    wall.object3D.position,wall.object3D.quaternion,wall.object3D.scale
  );
  wall.object3D.scale.set(1,1,1);

  const q=wall.object3D.quaternion;
  const right=new THREE.Vector3(1,0,0).applyQuaternion(q);
  const up=new THREE.Vector3(0,1,0).applyQuaternion(q);
  const dx=(WALL_W/2-ANCHOR_X);
  const dy=(ANCHOR_Y-WALL_H/2);
  wall.object3D.position.addScaledVector(right,dx);
  wall.object3D.position.addScaledVector(up,dy);

  wall.setAttribute('visible','true');
  locked=true;
  statusEl.textContent='å·²é–å®šï¼Œå¯æ ¡æ­£ä¸¦å„²å­˜';
  basePose={pos:wall.object3D.position.clone(),quat:wall.object3D.quaternion.clone(),scl:wall.object3D.scale.clone()};
  applyResetPose();
  ctrl.style.display='block';

  ghost.style.opacity=0;
  setTimeout(()=>ghost.style.display='none',260);

  setTimeout(forceVideoMaterialRefresh,120);
});

marker.addEventListener('targetLost',()=>{
  log('ğŸŸ¡ targetLost');
  tfBadge.style.display='none';
  ghost.style.display='block';
  requestAnimationFrame(()=>ghost.style.opacity=getGhostAlpha());
});

scene.addEventListener('loaded',()=>{
  log('å°±ç·’ï¼šæŒ‰ã€Œå•Ÿå‹• ARã€â†’ æˆæ¬Šç›¸æ©Ÿ â†’ å°æº–éŒ¨é» â†’ è‡ªå‹•é–å®š â†’ å¾®èª¿å„²å­˜ã€‚');
  setFine();
});

/* â€”â€” éŒ¨é»åœ–æ§åˆ¶ â€”â€” */
const alphaEl=document.getElementById('ghostAlpha');
const getGhostAlpha=()=>alphaEl?parseFloat(alphaEl.value||'0.35'):0.35;
function toggleGhost(){
  const vis=ghost.style.display!=='none';
  if(vis){ghost.style.display='none';}
  else{ghost.style.display='block';ghost.style.opacity=getGhostAlpha();}
}
function setGhostAlpha(v){ghost.style.opacity=v;}
ghost.style.display='block';ghost.style.opacity=getGhostAlpha();

/* ====== å½±åƒåˆæˆï¼ˆç›¸æ©Ÿï¼‹A-Frameï¼›ä¸å«éŒ¨é»åœ–ï¼‰ ====== */
function drawCompositeTo(canvas){
  const ctx=canvas.getContext('2d');
  const w=window.innerWidth,h=window.innerHeight;
  canvas.width=w;canvas.height=h;

  if(bgCam&&bgCam.videoWidth&&bgCam.videoHeight){
    const vw=bgCam.videoWidth,vh=bgCam.videoHeight;
    const vr=vw/vh,cr=w/h;let dw,dh,dx,dy;
    if(vr>cr){dh=h;dw=h*vr;dx=(w-dw)/2;dy=0;}
    else{dw=w;dh=w/vr;dx=0;dy=(h-dh)/2;}
    ctx.drawImage(bgCam,dx,dy,dw,dh);
  }else{
    ctx.fillStyle='#000';ctx.fillRect(0,0,w,h);
  }

  const aCanvas=document.querySelector('canvas.a-canvas');
  if(aCanvas)ctx.drawImage(aCanvas,0,0,w,h);
}

function downloadBlob(blob,filename){
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href),1000);
}

function snap(){
  const cvs=document.createElement('canvas');
  drawCompositeTo(cvs);
  cvs.toBlob(b=>downloadBlob(b,`AR_Snap_${new Date().toISOString().replace(/[:.]/g,'-')}.png`),'image/png');
}

/* éŒ„å½±ï¼ˆMediaRecorder + captureStreamï¼‰ */
let rec={running:false,raf:0,canvas:null,ctx:null,stream:null,mr:null,chunks:[]};

function startCompositeLoop(){
  if(!rec.canvas){rec.canvas=document.createElement('canvas');rec.ctx=rec.canvas.getContext('2d');}
  const loop=()=>{drawCompositeTo(rec.canvas);rec.raf=requestAnimationFrame(loop);};
  loop();
}
function stopCompositeLoop(){cancelAnimationFrame(rec.raf);rec.raf=0;}

async function startRec(){
  startCompositeLoop();
  rec.stream=rec.canvas.captureStream(30);
  const mime=MediaRecorder.isTypeSupported('video/webm;codecs=vp9')?'video/webm;codecs=vp9':
             (MediaRecorder.isTypeSupported('video/webm;codecs=vp8')?'video/webm;codecs=vp8':'video/webm');
  rec.mr=new MediaRecorder(rec.stream,{mimeType:mime});
  rec.chunks=[];
  rec.mr.ondataavailable=e=>{if(e.data&&e.data.size)rec.chunks.push(e.data);};
  rec.mr.onstop=()=>{
    const blob=new Blob(rec.chunks,{type:rec.mr.mimeType});
    downloadBlob(blob,`AR_Recording_${new Date().toISOString().replace(/[:.]/g,'-')}.webm`);
    rec.chunks=[];
  };
  rec.mr.start();
  rec.running=true;
  recDot.style.display='block';
  document.getElementById('btnRec').textContent='â¹ åœæ­¢éŒ„å½±';
  log('ğŸ¬ é–‹å§‹éŒ„å½±');
}

function stopRec(){
  if(rec.mr&&rec.mr.state!=='inactive')rec.mr.stop();
  stopCompositeLoop();
  rec.running=false;
  recDot.style.display='none';
  document.getElementById('btnRec').textContent='âº é–‹å§‹éŒ„å½±';
  log('ğŸ›‘ éŒ„å½±å·²åœæ­¢');
}

function toggleRec(){if(rec.running)stopRec();else startRec();}

/* ======= è¨ºæ–·ï¼šåŸç”Ÿæ’­æ”¾ & äº‹ä»¶ ======= */
const v = document.getElementById('vid');
const nv = document.getElementById('nativeV');
const dstat = document.getElementById('dstat');
const dlog = document.getElementById('dlog');
const dPlay = document.getElementById('dPlay');
const dClose = document.getElementById('dClose');

function logD(s){ dlog.textContent += s + '\n'; dlog.scrollTop = dlog.scrollHeight; }
function updateStat(){
  const rs = v.readyState;  // 0..4
  const ns = v.networkState; // 0..3
  dstat.textContent = `readyState=${rs} networkState=${ns} muted=${v.muted}`;
}
['loadedmetadata','loadeddata','canplay','playing','pause','ended','waiting','stalled','suspend','ratechange','volumechange','error'].forEach(ev=>{
  v.addEventListener(ev,()=>{ logD('video event: ' + ev); updateStat(); });
});

dPlay.onclick = async () => {
  nv.src = v.currentSrc || v.src;
  nv.muted = true; // å…ˆéœéŸ³ç¢ºä¿è‡ªå‹•æ’­æ”¾
  nv.style.display = 'block';
  dClose.style.display = 'inline-block';
  try { await nv.play(); logD('âœ… åŸç”Ÿ <video> æ’­æ”¾æˆåŠŸ'); }
  catch(e){ logD('âŒ åŸç”Ÿæ’­æ”¾å¤±æ•—ï¼š' + e.message); }
  updateStat();
};
dClose.onclick = ()=>{ nv.pause(); nv.style.display='none'; dClose.style.display='none'; };

updateStat();
logD('æç¤ºï¼šAndroid ç”¨ Chrome é–‹å•Ÿã€httpsï¼ŒåŒç¶²åŸŸæœ€ä½³ï¼›è·¨ç¶²åŸŸéœ€ CORS + Accept-Rangesã€‚');

/* === ä¿å‘½è£œä¸ï¼šä»¥ Blob æ–¹å¼è¼‰å…¥å½±ç‰‡ï¼Œç¹é CORS/MIME/Range === */
(async function forceBlobVideo(){
  const srcAttr = v.getAttribute('src');
  const src = srcAttr || v.src;
  if(!src) return;
  try {
    // HEADï¼ˆå¯è§€å¯Ÿå›æ‡‰ï¼Œä½†å¤±æ•—ä¹Ÿä¸å½±éŸ¿å¾ŒçºŒï¼‰
    try{
      const head = await fetch(src, { method:'HEAD' });
      console.log('[HEAD]', head.status, head.headers.get('content-type'), head.headers.get('accept-ranges'));
    }catch(_e){}

    const res = await fetch(src);
    if (!res.ok) throw new Error('HTTP '+res.status);
    const blob = await res.blob();
    const url  = URL.createObjectURL(blob);

    v.removeAttribute('crossorigin'); // blob ä¸éœ€è¦ CORS
    v.src = url;
    nv.src = url;
    v.muted = true;
    nv.muted = true;

    await v.play().catch(()=>{});
    // å¼·åˆ¶æŠŠå½±ç‰‡ç‰©ä»¶å¡å›æè³ªä¸€æ¬¡
    [document.getElementById('wallVideo'), document.getElementById('testOnMarker')].forEach(p=>{
      const m = p?.getObject3D('mesh');
      if (m && m.material && m.material.map) {
        m.material.map.image = v;
        m.material.map.needsUpdate = true;
        m.material.needsUpdate = true;
      }
    });
    console.log('âœ… Blob å½±ç‰‡å·²è¼‰å…¥ä¸¦å•Ÿæ’­');
  } catch (e) {
    console.warn('âŒ Blob è¼‰å…¥å¤±æ•—ï¼š', e);
  }
})();
</script>
</body>
</html>
