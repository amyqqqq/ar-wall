<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>å¤§ç‰† ARï½œå¤§ç‰†å°é½Šï¼‹å¾®èª¿ç‰ˆï¼ˆ4 éŒ¨é»ï¼‰</title>

<!-- å®˜æ–¹ç‰ˆæœ¬ï¼šA-Frame 1.6.0 + mind-ar 1.2.5 -->
<script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

<style>
  body{
    margin:0;
    overflow:hidden;
    background:#000;
    color:#0f0;
    font-family:monospace;
  }

  #top{
    position:fixed;
    left:8px;
    top:8px;
    z-index:10;
    display:flex;
    gap:6px;
    align-items:center;
    padding:4px 6px;
    background:rgba(0,0,0,.45);
    border-radius:8px;
    flex-wrap:wrap;
  }
  #top button{
    padding:3px 6px;
    font-size:12px;
  }
  #status{
    font-size:12px;
    opacity:.85;
    min-width:140px;
  }
  #posInfo{
    font-size:11px;
    opacity:.8;
  }
</style>
<style>
  a-enter-vr-button, .a-enter-vr-button {
    display: none !important;
  }
</style>

</head>
<body>

<div id="top">
  <button id="btnWall" disabled>åˆ‡åˆ°å¤§ç‰†</button>
  <button id="btnLeft">â¬…</button>
  <button id="btnRight">â¡</button>
  <button id="btnUp">â¬†</button>
  <button id="btnDown">â¬‡</button>
  <span id="status">ç­‰å¾…éŒ¨é»â€¦</span>
  <span id="posInfo"></span>
</div>

<a-scene
  mindar-image="imageTargetSrc: ./wall-anchor.mind?v=20251113; autoStart: true; missTolerance: 15"
  color-space="sRGB"
  renderer="colorManagement: true; physicallyCorrectLights: true"
  vr-mode-ui="enabled: false"
  device-orientation-permission-ui="enabled: false">

  <a-assets timeout="30000">
    <video id="vid" src="./video.mp4"
           preload="auto"
           playsinline webkit-playsinline
           muted
           crossorigin="anonymous"></video>
  </a-assets>

  <!-- camera -->
  <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

  <!-- 4 å€‹éŒ¨é»ï¼štargetIndex 0~3ï¼Œéƒ½æ›åŒä¸€æ”¯å½±ç‰‡ -->
  <!-- å°å°ºå¯¸å…ˆå°é½Šï¼ŒæŒ‰ã€Œåˆ‡åˆ°å¤§ç‰†ã€ä¹‹å¾Œæ‰æ”¾å¤§æˆæ•´é¢ç‰† -->
  <a-entity id="marker0" class="marker" mindar-image-target="targetIndex: 0">
    <a-plane class="wall-plane"
      position="0 0 0"
      width="0.8" height="0.4"
      material="shader:flat; src:#vid; side:double; transparent:true; alphaTest:0.01">
    </a-plane>
  </a-entity>

  <a-entity id="marker1" class="marker" mindar-image-target="targetIndex: 1">
    <a-plane class="wall-plane"
      position="0 0 0"
      width="0.8" height="0.4"
      material="shader:flat; src:#vid; side:double; transparent:true; alphaTest:0.01">
    </a-plane>
  </a-entity>

  <a-entity id="marker2" class="marker" mindar-image-target="targetIndex: 2">
    <a-plane class="wall-plane"
      position="0 0 0"
      width="0.8" height="0.4"
      material="shader:flat; src:#vid; side:double; transparent:true; alphaTest:0.01">
    </a-plane>
  </a-entity>

  <a-entity id="marker3" class="marker" mindar-image-target="targetIndex: 3">
    <a-plane class="wall-plane"
      position="0 0 0"
      width="0.8" height="0.4"
      material="shader:flat; src:#vid; side:double; transparent:true; alphaTest:0.01">
    </a-plane>
  </a-entity>

</a-scene>

<script>
const v        = document.getElementById('vid');
const btnWall  = document.getElementById('btnWall');
const btnLeft  = document.getElementById('btnLeft');
const btnRight = document.getElementById('btnRight');
const btnUp    = document.getElementById('btnUp');
const btnDown  = document.getElementById('btnDown');
const statusEl = document.getElementById('status');
const posInfo  = document.getElementById('posInfo');

const markers = Array.from(document.querySelectorAll('.marker'));
const planes  = Array.from(document.querySelectorAll('.wall-plane'));

const NUM = markers.length;

let isWallMode = false;
let activeMarkerIndex = null; // ç›®å‰å°åˆ°çš„é‚£ä¸€é¡†éŒ¨é» indexï¼ˆ0~3 æˆ– nullï¼‰

// ç‰†çš„å¯¦éš›å°ºå¯¸ï¼ˆå…¬å°ºï¼‰
const WALL_W = 15.14;
const WALL_H = 3.283;

// æ¯ä¸€é¡†éŒ¨é»å„è‡ªçš„ã€Œç‰†ä½ç½®å¾®èª¿å€¼ã€
// å…ˆå…¨éƒ¨çµ¦ä¸€æ¨£çš„é ä¼°å€¼ï¼Œä¹‹å¾Œå¯ä»¥é‡å°æ¯é¡†éŒ¨é»ç”¨ç®­é ­æ…¢æ…¢èª¿
const wallPosList = Array.from({length: NUM}, () => ({
  x: 6.2, // é€™è£¡å¯ä»¥ä¹‹å¾Œä¾ç…§å¯¦éš›ç‰†é¢ä¸€é¡†ä¸€é¡†æ”¹
  y: 0,
  z: 0
}));

// æ‰‹æ©Ÿäº’å‹•ä¸€æ¬¡çµ¦å½±ç‰‡æ’­æ”¾æ¬Šé™
function tryPlay(){ v.play().catch(()=>{}); }
['loadeddata','canplay'].forEach(ev => v.addEventListener(ev, tryPlay, {once:true}));
window.addEventListener('pointerdown', tryPlay, {once:true});
window.addEventListener('touchstart', tryPlay, {once:true, passive:true});

function updatePosLabel(){
  if(activeMarkerIndex === null){
    posInfo.textContent = '';
    return;
  }
  const p = wallPosList[activeMarkerIndex];
  posInfo.textContent = `éŒ¨é» #${activeMarkerIndex} pos x=${p.x.toFixed(2)}m, y=${p.y.toFixed(2)}m`;
}

// ç¶å®šæ¯ä¸€é¡†éŒ¨é»çš„äº‹ä»¶
markers.forEach((marker, idx) => {
  const plane = planes[idx];

  marker.addEventListener('targetFound', () => {
    console.log('ğŸ¯ targetFound', idx);
    activeMarkerIndex = idx;
    btnWall.disabled = false;
    statusEl.textContent = `å·²é–å®šéŒ¨é» #${idx}ï¼Œå¯åˆ‡åˆ°å¤§ç‰†`;
    v.play().catch(()=>{});

    if(isWallMode){
      // å¤§ç‰†æ¨¡å¼ä¸‹ï¼šåªé¡¯ç¤ºé€™é¡†éŒ¨é»çš„ planeï¼Œå…¶é¤˜é—œæ‰
      planes.forEach((p, i) => {
        p.object3D.visible = (i === idx);
      });
      // ç¢ºä¿ä½ç½®ç”¨ç›®å‰çš„å¾®èª¿å€¼
      const p = wallPosList[idx];
      plane.setAttribute('position', `${p.x} ${p.y} ${p.z}`);
    }
  });

  marker.addEventListener('targetLost', () => {
    console.log('âš  targetLost', idx);
    statusEl.textContent = `éŒ¨é» #${idx} éºå¤±ï¼Œè«‹å†å°æº–ä»»ä¸€éŒ¨é»`;
    plane.object3D.visible = false;

    // å¦‚æœç¾åœ¨ active å°±æŠŠ active æ¸…æ‰ï¼ˆç­‰ä¸‹ä¸€é¡†éŒ¨é»æ¥åŠ›ï¼‰
    if(activeMarkerIndex === idx){
      activeMarkerIndex = null;
      updatePosLabel();
    }
  });
});

// åˆ‡åˆ°å¤§ç‰†ï¼šæ”¾å¤§æ‰€æœ‰ planeï¼Œå¯¦éš›é¡¯ç¤ºåªé¡¯ç¤ºã€Œç›®å‰å°åˆ°çš„é‚£ä¸€é¡†ã€
btnWall.addEventListener('click', () => {
  if(activeMarkerIndex === null) return;

  planes.forEach((plane, idx) => {
    plane.setAttribute('width',  WALL_W);
    plane.setAttribute('height', WALL_H);

    const p = wallPosList[idx];
    plane.setAttribute('position', `${p.x} ${p.y} ${p.z}`);

    // åªé¡¯ç¤ºç•¶å‰é€™ä¸€é¡†éŒ¨é»çš„ plane
    plane.object3D.visible = (idx === activeMarkerIndex);
  });

  isWallMode = true;
  statusEl.textContent = 'å¤§ç‰†æ¨¡å¼ï¼šå¯ç”¨ç®­é ­å¾®èª¿ä½ç½®ï¼ˆæ¯é¡†éŒ¨é»å„è‡ªè¨˜éŒ„ï¼‰';
  updatePosLabel();
  v.play().catch(()=>{});
});

// å¾®èª¿å‡½å¼ï¼ˆå·¦å³ä¸Šä¸‹ï¼‰â€” åªå‹•ã€Œç›®å‰é€™ä¸€é¡†éŒ¨é»ã€çš„ç‰†ä½ç½®
function nudge(dx, dy){
  if(!isWallMode) return;
  if(activeMarkerIndex === null) return;

  const p = wallPosList[activeMarkerIndex];
  p.x += dx;
  p.y += dy;

  const plane = planes[activeMarkerIndex];
  plane.setAttribute('position', `${p.x} ${p.y} ${p.z}`);
  updatePosLabel();
}

btnLeft .addEventListener('click', () => nudge(-0.1, 0));
btnRight.addEventListener('click', () => nudge( 0.1, 0));
btnUp   .addEventListener('click', () => nudge(0,  0.1));
btnDown .addEventListener('click', () => nudge(0, -0.1));

updatePosLabel();
</script>
</body>
</html>
