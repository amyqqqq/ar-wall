<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
<title>å¤§ç‰† ARï½œè¡Œå‹•è¨ºæ–·ï¼‹æµ®å‹•éµç‰ˆï¼ˆæ¥µç°¡ç©©å®šç‰ˆï¼‰</title>

<!-- A-Frame + MindARï¼ˆé †åºï¼‰ -->
<script src="https://unpkg.com/aframe@1.4.2/dist/aframe.min.js"></script>
<script src="https://unpkg.com/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

<style>
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:#000;color:#0f0;font-family:monospace;overflow:hidden}
  /* åªå‹• UIï¼Œä¸ç¢° A-Frame canvasï¼Œé¿å…åç§» */
  #top{position:fixed;left:8px;top:8px;z-index:99999;display:flex;gap:6px;align-items:center}
  #top button{padding:8px 12px}
  #log{position:fixed;left:8px;bottom:8px;right:8px;height:140px;overflow:auto;background:rgba(0,0,0,.55);padding:8px;z-index:99999;font-size:12px;line-height:1.25;word-wrap:break-word;overflow-wrap:anywhere}
  #tfBadge{position:fixed;right:12px;top:40px;z-index:99999;background:#29b6f6;color:#000;padding:6px 10px;border-radius:8px;display:none;font-weight:bold;}
  #diag{position:fixed;right:8px;bottom:72px;z-index:100000;background:#000a;color:#fff;padding:8px;border-radius:8px;max-width:70vw;font:12px monospace;display:none}
  #nativeV{display:none;position:fixed;inset:0;z-index:100001;width:100vw;height:100vh;object-fit:contain;background:#000}
  #btnDiagFab{
    position:fixed;right:12px;bottom:12px;width:56px;height:56px;border-radius:50%;
    background:rgba(0,0,0,.8);color:#0f0;border:1px solid #0f0;font-weight:700;z-index:100002;box-shadow:0 2px 10px #000a;
  }
  .mindar-ui-loading,.mindar-ui-scanning{display:none !important;}
</style>
</head>
<body>

<div id="tfBadge">ğŸ¯ targetFound</div>

<div id="top">
  <button id="btnStart">å•Ÿå‹• AR</button>
  <button id="btnForcePlay">â–¶ æ‰‹å‹•æ’­æ”¾</button>
  <button id="btnShowWall" disabled>åˆ‡åˆ°å¤§ç‰†</button>
  <span id="status">æœªå•Ÿå‹•</span>
</div>
<div id="log"></div>

<!-- è¨ºæ–·é¢æ¿ -->
<div id="diag">
  <div>è¨ºæ–·ï¼š<span id="dstat">æœªé–‹å§‹</span></div>
  <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">
    <button id="dPlay">åŸç”Ÿæ’­æ”¾</button>
    <button id="dClose" style="display:none">é—œé–‰åŸç”Ÿ</button>
  </div>
  <div id="dlog" style="margin-top:6px;max-height:28vh;overflow:auto;white-space:pre-wrap"></div>
</div>
<video id="nativeV" playsinline webkit-playsinline controls muted></video>

<!-- æµ®å‹•è¨ºæ–·éµ -->
<button id="btnDiagFab">è¨º</button>

<!-- AR å ´æ™¯ï¼ˆä¸è¦ embeddedï¼Œä¹Ÿä¸è¦è‡ªè¨‚ canvas æ¨£å¼ï¼‰ -->
<a-scene
  color-space="sRGB"
  vr-mode-ui="enabled:false"
  device-orientation-permission-ui="enabled:false"
  mindar-image="imageTargetSrc: ./wall-anchor.mind; autoStart: false; maxTrack: 1"
  renderer="alpha:true; colorManagement:true; physicallyCorrectLights:true">

  <a-assets timeout="30000">
    <!-- ç›´æ¥ç”¨åŒå±¤çš„ video.mp4 -->
    <video id="vid" src="./video.mp4" preload="auto" playsinline webkit-playsinline muted crossorigin="anonymous"></video>
  </a-assets>

  <!-- å…ˆæŠŠå½±ç‰‡è²¼åœ¨ marker ä¸Šçš„å°æ¸¬è©¦å¹³é¢ï¼Œç¢ºèª targetFound æœ‰åæ‡‰ -->
  <a-entity id="marker" mindar-image-target="targetIndex:0">
    <a-plane id="testOnMarker" position="0 0 0.01" width="0.6" height="0.13"
      material="shader:flat; src:#vid; side:double; transparent:true; alphaTest:0.01" visible="false"></a-plane>
  </a-entity>

  <!-- ä¹‹å¾Œè¦åˆ‡æˆå¤§ç‰†æ™‚ç”¨ï¼ˆé è¨­ä¸é¡¯ç¤ºï¼›åˆ‡æ›æ™‚æœƒæŠŠå®ƒæ›åˆ° marker ä¸‹é¢ä¸¦èª¿æ•´å°ºå¯¸ï¼‰ -->
  <a-entity id="wallPlane" visible="false">
    <a-plane id="wallVideo" width="15.14" height="3.283" position="0 0 0"
      material="shader:flat; src:#vid; side:double; transparent:true; alphaTest:0.01"></a-plane>
  </a-entity>

  <a-entity camera="facingMode: environment"></a-entity>
</a-scene>

<script>
const logEl=document.getElementById('log');
const log=s=>{console.log(s);logEl.textContent+=s+"\n";logEl.scrollTop=logEl.scrollHeight;}
const statusEl=document.getElementById('status');
const v=document.getElementById('vid');
const wall=document.getElementById('wallPlane');
const wallVideo=document.getElementById('wallVideo');
const marker=document.getElementById('marker');
const scene=document.querySelector('a-scene');
const tfBadge=document.getElementById('tfBadge');
const btnShowWall=document.getElementById('btnShowWall');

let foundOnce=false;

/* å–®ç´”çš„æ’­æ”¾ä¿åº• */
function tryPlayVideo(){
  const kick=()=>v.play().catch(()=>{});
  kick();
  v.addEventListener('loadeddata',kick,{once:true});
  v.addEventListener('canplay',kick,{once:true});
  window.addEventListener('touchstart',kick,{once:true,passive:true});
  window.addEventListener('pointerdown',kick,{once:true});
}

/* å•Ÿå‹•æµç¨‹ */
document.getElementById('btnStart').onclick=async()=>{
  try{
    statusEl.textContent='è«‹æˆæ¬Šç›¸æ©Ÿâ€¦';
    if(!navigator.mediaDevices?.getUserMedia) throw new Error('ç„¡æ³•å–ç”¨ç›¸æ©Ÿ');
    const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}},audio:false});
    s.getTracks().forEach(t=>t.stop());

    statusEl.textContent='å•Ÿå‹•ä¸­â€¦';
    if(!scene.hasLoaded){
      await new Promise(r=>scene.addEventListener('loaded',r,{once:true}));
    }
    const arSystem=scene.systems['mindar-image-system']||scene.systems['mindar-image'];
    await arSystem.start();

    // è®“ MindAR è‡ªå·±è™•ç†å°ºå¯¸ï¼Œä¸å†å¼·åˆ¶ setSizeï¼ˆé¿å…è®Šçª„åå³ï¼‰
    statusEl.textContent='è«‹å°æº–éŒ¨é»';
    log('âœ… AR å·²å•Ÿå‹•');

    v.load();
    tryPlayVideo();
  }catch(e){ statusEl.textContent='å•Ÿå‹•å¤±æ•—'; log('ğŸŸ¥ '+e.message); }
};

/* æ‰‹å‹•æ’­æ”¾ */
document.getElementById('btnForcePlay').onclick=()=>{v.play().then(()=>log('â–¶ï¸ æ‰‹å‹•æ’­æ”¾æˆåŠŸ')).catch(e=>log('ğŸŸ¥ '+e.message));};

/* target äº‹ä»¶ï¼ˆå…ˆè®“ marker ä¸Šçš„å°å¹³é¢äº®èµ·é©—è­‰ï¼‰ */
marker.addEventListener('targetFound',()=>{
  tfBadge.style.display='block';
  log('ğŸ¯ targetFound');
  foundOnce=true;
  document.getElementById('testOnMarker').setAttribute('visible','true');
  v.play().catch(()=>{});
  btnShowWall.disabled=false;
});
marker.addEventListener('targetLost',()=>{tfBadge.style.display='none';});

/* åˆ‡åˆ°å¤§ç‰†ï¼šæŠŠå¤§ç‰†ç¯€é»æ›åˆ° marker ä¸‹é¢ï¼Œå†ç¸®æ”¾åˆ°è¼ƒåˆç†çš„å¤§å°ï¼ˆå…ˆç¤ºæ„ 3m å¯¬ï¼‰ */
btnShowWall.onclick=()=>{
  if(!foundOnce){ return; }
  // æ›åˆ° markerï¼ˆé¿å…ä¸–ç•ŒçŸ©é™£æ‹·è²å‡ºç¾åº§æ¨™/æ¯”ä¾‹å·®ç•°ï¼‰
  marker.appendChild(wall);
  // ä»¥ 3 å…¬å°ºå¯¬ç¤ºæ„ï¼Œä¿æŒåŸå§‹å¯¬é«˜æ¯”ï¼ˆä½ å¯æ”¹å› 15.14 x 3.283ï¼‰
  wallVideo.setAttribute('width', 3.0);
  wallVideo.setAttribute('height', 3.0 * (3.283/15.14));
  wall.setAttribute('position','0 0 0.01');
  wall.setAttribute('visible','true');
  v.play().catch(()=>{});
  log('ğŸ§± å·²åˆ‡åˆ°å¤§ç‰†å¹³é¢ï¼ˆç¤ºæ„ 3m å¯¬ï¼Œå¯å†èª¿æ•´ç‚ºå¯¦éš› 15.14mï¼‰');
};

/* === è¨ºæ–· === */
const nv=document.getElementById('nativeV');
const diag=document.getElementById('diag');
const dstat=document.getElementById('dstat');
const dlog=document.getElementById('dlog');
const dPlay=document.getElementById('dPlay');
const dClose=document.getElementById('dClose');
function logD(s){dlog.textContent+=s+'\n';dlog.scrollTop=dlog.scrollHeight;}
function updateStat(){dstat.textContent=`readyState=${v.readyState} networkState=${v.networkState} muted=${v.muted}`;}
['loadedmetadata','loadeddata','canplay','playing','pause','ended','waiting','stalled','suspend','error']
  .forEach(ev=>v.addEventListener(ev,()=>{logD('video event:'+ev);updateStat();}));

dPlay.onclick=async()=>{nv.src=v.currentSrc||v.src;nv.muted=true;nv.style.display='block';dClose.style.display='inline-block';try{await nv.play();logD('âœ… åŸç”Ÿæ’­æ”¾æˆåŠŸ');}catch(e){logD('âŒ '+e.message);}updateStat();};
dClose.onclick=()=>{nv.pause();nv.style.display='none';dClose.style.display='none';};

/* æµ®å‹•éµé–‹å•Ÿè¨ºæ–·é¢æ¿ */
document.getElementById('btnDiagFab').onclick=()=>{
  diag.style.display='block';
  diag.style.zIndex=100000;
  nv.src=v.currentSrc||v.src;
  nv.muted=true;
  nv.style.display='block';
  nv.play().catch(()=>{});
};
</script>
</body>
</html>
