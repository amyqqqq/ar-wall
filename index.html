<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>å¤§ç‰† ARï½œå–®éŒ¨é–å®šï¼‹æ ¡æ­£ï¼ˆè¡Œå‹•è¨ºæ–·ï¼‹æ ¼å¼åµæ¸¬ç‰ˆï¼‰</title>

<!-- A-Frame å…ˆè¼‰ï¼Œå†è¼‰ MindARï¼ˆé †åºé‡è¦ï¼‰ -->
<script src="https://unpkg.com/aframe@1.4.2/dist/aframe.min.js"></script>
<script src="https://unpkg.com/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

<style>
  html,body{margin:0;height:100%;background:#000;color:#0f0;font-family:monospace;overflow:hidden;}
  a-scene{position:fixed !important;inset:0 !important;width:100vw !important;height:100vh !important;z-index:1;}
  canvas.a-canvas{width:100vw !important;height:100vh !important;background:transparent !important;pointer-events:none !important;z-index:1;}
  #bgCam{position:fixed;left:0;top:0;width:100vw;height:100vh;object-fit:cover;z-index:0;display:block;opacity:1}
  .mindar-ui-loading,.mindar-ui-scanning{display:none !important;}
  #top{position:fixed;left:8px;top:8px;z-index:10;display:flex;gap:6px;align-items:center}
  #top button{padding:8px 12px}
  #log{position:fixed;left:8px;bottom:8px;right:8px;height:140px;overflow:auto;background:rgba(0,0,0,.55);padding:8px;z-index:10;font-size:12px;line-height:1.25;}
  /* è¨ºæ–·é¢æ¿ï¼‹åŸç”Ÿæ’­æ”¾å™¨ï¼ˆè¡Œå‹•å‹å–„ï¼‰ */
  #diag{position:fixed;right:8px;bottom:72px;z-index:99999;background:#000a;color:#fff;padding:8px;border-radius:8px;max-width:70vw;font:12px monospace;display:none}
  #nativeV{display:none;position:fixed;inset:0;z-index:100000;width:100vw;height:100vh;object-fit:contain;background:#000}
  #tfBadge{position:fixed;right:12px;top:40px;z-index:12;background:#f33;color:#fff;padding:6px 10px;border-radius:8px;display:none;font-weight:bold;}
</style>
</head>
<body>
<video id="bgCam" autoplay muted playsinline webkit-playsinline></video>
<div id="tfBadge">ğŸ¯ targetFound</div>

<!-- é ‚éƒ¨å·¥å…·åˆ— -->
<div id="top">
  <button id="btnStart">å•Ÿå‹• AR</button>
  <button id="btnForcePlay">â–¶ æ‰‹å‹•æ’­æ”¾</button>
  <button id="btnDiag">è¨ºæ–·</button>
  <span id="status">æœªå•Ÿå‹•</span>
</div>

<div id="log"></div>

<!-- è¨ºæ–·é¢æ¿ + åŸç”Ÿæ’­æ”¾ -->
<div id="diag">
  <div>è¨ºæ–·ï¼š<span id="dstat">æœªé–‹å§‹</span></div>
  <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">
    <button id="dPlay">åŸç”Ÿæ’­æ”¾</button>
    <button id="dClose" style="display:none">é—œé–‰åŸç”Ÿ</button>
  </div>
  <div id="dlog" style="margin-top:6px;max-height:28vh;overflow:auto;white-space:pre-wrap"></div>
</div>
<video id="nativeV" playsinline webkit-playsinline controls muted></video>

<!-- AR å ´æ™¯ -->
<a-scene
  embedded color-space="sRGB"
  vr-mode-ui="enabled:false"
  device-orientation-permission-ui="enabled:false"
  mindar-image="imageTargetSrc: ./wall-anchor.mind; autoStart: false; maxTrack: 1;"
  renderer="alpha:true; colorManagement:true; physicallyCorrectLights:true">

  <a-assets timeout="30000">
    <!-- ä¸å…ˆçµ¦ srcï¼Œäº¤ç”± JS ä¾ç›¸å®¹æ€§æ±ºå®š -->
    <video id="vid" preload="auto" playsinline webkit-playsinline muted crossorigin="anonymous"></video>
  </a-assets>

  <!-- æƒåˆ°éŒ¨é»çš„å°æ¸¬è©¦ç‰‡ï¼Œç¢ºä¿æè³ªç¶å®š -->
  <a-entity id="marker" mindar-image-target="targetIndex:0">
    <a-plane id="testOnMarker" position="0 0 0.01" width="0.6" height="0.13"
      material="shader:flat; src:#vid; side:double; transparent:true; alphaTest:0.01"
      visible="true"></a-plane>
  </a-entity>

  <!-- ç‰†é¢å¤§ç•«é¢ï¼ˆåˆæœŸå…ˆéš±è—ï¼Œ2ç§’æœªé–å®šæœƒé¡¯ç¤ºä»¥åµéŒ¯ï¼‰ -->
  <a-entity id="wallPlane" visible="false">
    <a-plane id="wallVideo" width="15.14" height="3.283" position="0 0 0"
      material="shader:flat; src:#vid; side:double; transparent:true; alphaTest:0.01"></a-plane>
  </a-entity>

  <a-entity camera="facingMode: environment"></a-entity>
</a-scene>

<script>
/* ========== å°å·¥å…· ========== */
const logEl=document.getElementById('log');
const log=s=>{console.log(s);logEl.textContent+=s+"\n";logEl.scrollTop=logEl.scrollHeight;}
const statusEl=document.getElementById('status');
const btnStart=document.getElementById('btnStart');
const btnForcePlay=document.getElementById('btnForcePlay');
const btnDiag=document.getElementById('btnDiag');
const scene=document.querySelector('a-scene');
const marker=document.getElementById('marker');
const wall=document.getElementById('wallPlane');
const wallPlaneEl=document.getElementById('wallVideo');
const testOnMarker=document.getElementById('testOnMarker');
const v=document.getElementById('vid');
const bgCam=document.getElementById('bgCam');
const tfBadge=document.getElementById('tfBadge');
let locked=false;

/* ========== ç›¸å®¹æ€§é¸ç‰‡ï¼ˆè«‹æŠŠæª”åæ”¾åœ¨é€™ï¼‰ ========== */
const candidates = [
  {src: './video_h264_1080.mp4', type: 'video/mp4; codecs="avc1.640028"'},
  {src: './video_vp9_1080.webm', type: 'video/webm; codecs="vp9"'},
  // æœ€å¾Œæ‰é€€å›åŸæª”ï¼ˆè‹¥ä½ åªæœ‰ä¸€æ”¯ï¼šè«‹æŠŠè·¯å¾‘æ”¹æˆä½ çš„ mp4ï¼‰
  {src: './video.mp4', type: 'video/mp4'}
];
const pick = candidates.find(c => v.canPlayType(c.type));
v.src = (pick ? pick.src : candidates[0].src);
v.muted = true; v.playsInline = true;

/* ========== è®“æè³ªé€£çºŒåˆ·æ–°ï¼ˆé¿å…é¦–å¹€å¡ä½ï¼‰ ========== */
AFRAME.registerComponent('video-texture-tick', {
  schema: { src: {type:'selector'} },
  init() {
    this.video = this.data.src || v;
    this.mesh = null;
    this.bind = () => {
      const m = this.el.getObject3D('mesh'); if(!m) return;
      this.mesh = m;
      const mat = m.material;
      if (mat && mat.map) { mat.map.image = this.video; mat.map.needsUpdate = true; mat.needsUpdate = true; }
    };
    this.el.addEventListener('model-loaded', this.bind);
    this.bind();
  },
  tick() {
    if (!this.mesh || !this.video) return;
    if (this.video.readyState >= 2) {
      const mat = this.mesh.material;
      if (mat && mat.map) mat.map.needsUpdate = true;
    }
  }
});
window.addEventListener('DOMContentLoaded', ()=>{
  wallPlaneEl?.setAttribute('video-texture-tick','src:#vid');
  testOnMarker?.setAttribute('video-texture-tick','src:#vid');
});

/* ========== æ’­æ”¾èˆ‡æè³ªä¿åº• ========== */
function forceVideoMaterialRefresh(){
  [wallPlaneEl, testOnMarker].forEach(p=>{
    const m=p?.getObject3D('mesh');
    if(m&&m.material){
      if(m.material.map){ m.material.map.image=v; m.material.map.needsUpdate=true; }
      m.material.needsUpdate=true;
    }
  });
  log('ğŸ§© material.needsUpdate=true');
}
function tryPlayVideoChain(){
  const go=()=>v.play().catch(()=>{});
  go();
  v.addEventListener('loadeddata',()=>{go();forceVideoMaterialRefresh();},{once:true});
  v.addEventListener('canplay',   ()=>{go();forceVideoMaterialRefresh();},{once:true});
  v.addEventListener('playing',   ()=>{log('ğŸï¸ playing');forceVideoMaterialRefresh();},{once:true});
  setTimeout(()=>{ if(v.readyState<2){ v.load(); go(); } forceVideoMaterialRefresh(); }, 400);
}

/* ========== Scene å•Ÿå‹•èˆ‡ç›¸æ©Ÿä¸²æµé¡åƒåˆ° bgCam ========== */
async function waitSceneLoaded(el){if(el.hasLoaded)return;await new Promise(r=>el.addEventListener('loaded',r,{once:true}));}
async function ensureCam(){
  if(!navigator.mediaDevices?.getUserMedia)throw new Error('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ getUserMedia');
  const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}},audio:false});
  s.getTracks().forEach(t=>t.stop());
}
btnStart.onclick=async()=>{
  try{
    statusEl.textContent='è«‹æˆæ¬Šç›¸æ©Ÿâ€¦';
    await ensureCam();
    statusEl.textContent='å•Ÿå‹•ä¸­â€¦';
    await waitSceneLoaded(scene);

    const arSystem=scene.systems['mindar-image-system']||scene.systems['mindar-image']||(scene.components['mindar-image']?.system);
    if(!arSystem?.start){statusEl.textContent='å•Ÿå‹•å¤±æ•—ï¼ˆMindAR æœªåˆå§‹åŒ–ï¼‰';log('ğŸŸ¥ MindAR system not ready');return;}

    await arSystem.start();
    statusEl.textContent='è«‹å°æº–éŒ¨é»';
    log('âœ… AR å·²å•Ÿå‹•ï¼Œç­‰å¾… targetFoundâ€¦');

    if(arSystem.video && arSystem.video.srcObject){
      try{ bgCam.muted=true; bgCam.playsInline=true; bgCam.srcObject=arSystem.video.srcObject; bgCam.play().catch(()=>{}); }
      catch(e){log('ğŸŸ¥ è¤‡è£½ç›¸æ©Ÿä¸²æµå¤±æ•—ï¼š'+e.message);}
    }
    bgCam.addEventListener('loadedmetadata',()=>{log(`ğŸ“· ç›¸æ©Ÿå•Ÿå‹•ï¼š${bgCam.videoWidth}x${bgCam.videoHeight}`);});

    v.load(); tryPlayVideoChain();

    // 2 ç§’æœªé–å®šï¼šé¡¯ç¤ºå¤§ç‰†è¦†å±¤ä»¥åµéŒ¯
    setTimeout(()=>{ if(!locked){ wall.setAttribute('visible','true'); tryPlayVideoChain(); log('ğŸ§ª 2ç§’æœª targetFoundï¼Œå…ˆé¡¯ç¤ºè¦†å±¤/å˜—è©¦æ’­æ”¾'); }},2000);
  }catch(e){
    statusEl.textContent='å•Ÿå‹•å¤±æ•—';
    log('ğŸŸ¥ å•Ÿå‹•å¤±æ•—ï¼š'+e.name+' / '+e.message);
  }
};

/* ========== æ‰‹å‹¢ä¿åº•æ’­æ”¾ï¼ˆè¡Œå‹•å¿…è¦ï¼‰ ========== */
const onceGesturePlay = () => { v.muted=true; v.play().catch(()=>{}); window.removeEventListener('touchstart', onceGesturePlay, {passive:true}); window.removeEventListener('pointerdown', onceGesturePlay); };
window.addEventListener('touchstart', onceGesturePlay, {passive:true, once:true});
window.addEventListener('pointerdown', onceGesturePlay, {once:true});

btnForcePlay.onclick=()=>{ v.play().then(()=>{log('â–¶ï¸ æ‰‹å‹•æ’­æ”¾æˆåŠŸ');forceVideoMaterialRefresh();}).catch(err=>log('ğŸŸ¥ æ‰‹å‹•æ’­æ”¾å¤±æ•—ï¼š'+err.name+' / '+err.message)); };

/* ========== target äº‹ä»¶ï¼šé–å®šä¸¦å¥—ä½å§¿ ========== */
marker.addEventListener('targetFound',()=>{
  log('ğŸ¯ æ‰¾åˆ°éŒ¨é» â†’ é¡¯ç¤ºç‰†é¢ä¸¦æ’­æ”¾');
  tfBadge.style.display='block';
  tryPlayVideoChain();
  // ç›´æ¥æŠŠç‰†é¢ç–Šåˆ° markerï¼ˆä½ å¦‚éœ€å¯¦éš›åç§»ï¼Œå¯åœ¨é€™è£¡åšï¼‰
  const m=marker.object3D.matrixWorld.clone();
  wall.object3D.matrix.copy(m);
  wall.object3D.matrix.decompose(wall.object3D.position,wall.object3D.quaternion,wall.object3D.scale);
  wall.setAttribute('visible','true');
  locked=true;
  statusEl.textContent='å·²é–å®š';
  setTimeout(forceVideoMaterialRefresh,120);
});
marker.addEventListener('targetLost',()=>{ log('ğŸŸ¡ targetLost'); tfBadge.style.display='none'; });

scene.addEventListener('loaded',()=>{ log('å°±ç·’ï¼šæŒ‰ã€Œå•Ÿå‹• ARã€â†’ æˆæ¬Šç›¸æ©Ÿ â†’ å°æº–éŒ¨é»ã€‚'); });

/* ========== è¨ºæ–·é¢æ¿ï¼ˆè¡Œå‹•å¿«æ·ï¼‰ ========== */
const nv = document.getElementById('nativeV');
const dstat = document.getElementById('dstat');
const dlog = document.getElementById('dlog');
const dPlay = document.getElementById('dPlay');
const dClose = document.getElementById('dClose');
function logD(s){ dlog.textContent += s + '\n'; dlog.scrollTop = dlog.scrollHeight; }
function updateStat(){ dstat.textContent = `readyState=${v.readyState} networkState=${v.networkState} muted=${v.muted}`; }
['loadedmetadata','loadeddata','canplay','playing','pause','ended','waiting','stalled','suspend','ratechange','volumechange','error'].forEach(ev=>{
  v.addEventListener(ev,()=>{ logD('video event: ' + ev); updateStat(); });
});
btnDiag.onclick = () => {
  const diag = document.getElementById('diag');
  diag.style.display = 'block';
  diag.style.zIndex  = 99999;
  nv.src = v.currentSrc || v.src;
  nv.muted = true;
  nv.style.display = 'block';
  nv.play().catch(()=>{});
  updateStat();
};
dPlay.onclick = async () => {
  nv.src = v.currentSrc || v.src; nv.muted = true; nv.style.display = 'block'; dClose.style.display = 'inline-block';
  try { await nv.play(); logD('âœ… åŸç”Ÿ <video> æ’­æ”¾æˆåŠŸ'); } catch(e){ logD('âŒ åŸç”Ÿæ’­æ”¾å¤±æ•—ï¼š' + e.message); }
  updateStat();
};
dClose.onclick = ()=>{ nv.pause(); nv.style.display='none'; dClose.style.display='none'; };
updateStat();
logD('æç¤ºï¼šAndroid ç”¨ Chrome é–‹å•Ÿã€httpsï¼ŒåŒç¶²åŸŸæœ€ä½³ï¼›è·¨ç¶²åŸŸéœ€ CORS + Accept-Rangesã€‚');

/* ========== ï¼ˆé¸ç”¨ï¼‰Blob æ–¹å¼è¼‰å…¥ï¼Œé¿ CORS/Rangeï¼ˆåŒæºå¯å¿½ç•¥ï¼‰ ========== */
(async function forceBlobVideo(){
  const src = v.currentSrc || v.src; if(!src) return;
  try {
    const res = await fetch(src); if (!res.ok) throw new Error('HTTP '+res.status);
    const blob = await res.blob(); const url  = URL.createObjectURL(blob);
    v.removeAttribute('crossorigin'); v.src = url; nv.src = url; v.muted = true; nv.muted = true;
    await v.play().catch(()=>{}); forceVideoMaterialRefresh(); log('âœ… Blob å½±ç‰‡å·²è¼‰å…¥ï¼ˆå¯ç¹¼çºŒä½¿ç”¨åŸç”Ÿè¨ºæ–·ï¼‰');
  } catch (e) { console.warn('âŒ Blob è¼‰å…¥å¤±æ•—ï¼š', e); }
})();
</script>
</body>
</html>
