<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>å¤§ç‰† ARï½œå–®éŒ¨é–å®šï¼‹æ ¡æ­£ï¼ˆç›´æ¥æ› arSystem.videoï¼‰</title>

<script src="https://unpkg.com/aframe@1.4.2/dist/aframe.min.js"></script>
<script src="https://unpkg.com/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

<style>
  html,body{margin:0;height:100%;background:#000;color:#0f0;font-family:monospace;overflow:hidden}
  a-scene{position:fixed !important;inset:0 !important;width:100vw !important;height:100vh !important;z-index:1}
  /* A-Frame ç•«å¸ƒé€æ˜ï¼Œé¿å…é»‘åº• */
  canvas.a-canvas{width:100vw !important;height:100vh !important;background:transparent !important;pointer-events:none !important;z-index:1}
  /* ç›´æ¥æ›åœ¨ DOM çš„ç›¸æ©Ÿ video å°ˆç”¨æ¨£å¼ */
  #bgCam{
    position:fixed; left:0; top:0; width:100vw; height:100vh;
    object-fit:cover; z-index:0; display:block; opacity:1;
    transform:none !important;
  }
  /* é—œæ‰ MindAR å…§å»ºé®ç½©/åœˆåœˆ */
  .mindar-ui-loading,.mindar-ui-scanning{display:none !important}

  #top{position:fixed;left:8px;top:8px;z-index:10}
  #log{position:fixed;left:8px;bottom:8px;right:8px;height:140px;overflow:auto;background:rgba(0,0,0,.55);padding:8px;z-index:10;font-size:12px;line-height:1.25}
  #ctrl{position:fixed;left:8px;bottom:160px;z-index:10;background:rgba(0,0,0,.5);border-radius:10px;padding:8px;display:none}
  #ctrl button{margin:2px 3px;padding:8px 12px}
  .row{margin:4px 0}
</style>
</head>
<body>
<!-- æˆ‘å€‘è‡ªå·±æ”¾ä¸€æ”¯ <video> ç•¶èƒŒæ™¯ï¼Œä¹‹å¾ŒæŠŠ arSystem.video æŒ‡éä¾† -->
<video id="bgCam" autoplay muted playsinline webkit-playsinline></video>

<div id="top">
  <button id="btnStart">å•Ÿå‹• AR</button>
  <span id="status">æœªå•Ÿå‹•</span>
</div>

<div id="ctrl">
  <div class="row">
    ä½ç½®ï¼š<button onclick="nudge(-step,0)">â†</button><button onclick="nudge(step,0)">â†’</button>
    <button onclick="nudge(0,step)">â†‘</button><button onclick="nudge(0,-step)">â†“</button>
  </div>
  <div class="row">æ—‹è½‰Zï¼š<button onclick="rot(-rotStep)">â†º</button><button onclick="rot(rotStep)">â†»</button></div>
  <div class="row">å°ºå¯¸ï¼š<button onclick="scaleMul(0.98)">ç¸®å°</button><button onclick="scaleMul(1.02)">æ”¾å¤§</button></div>
  <div class="row">
    ç²¾åº¦ï¼š<button onclick="setFine()">ç´°</button><button onclick="setCoarse()">ç²—</button>
    <button onclick="resetAdj()">é‡ç½®å¾®èª¿</button><button onclick="saveCfg()">ğŸ’¾ å„²å­˜</button><button onclick="reload()">é‡æ–°è¼‰å…¥</button>
  </div>
</div>

<div id="log"></div>

<a-scene
  embedded color-space="sRGB" vr-mode-ui="enabled:false" device-orientation-permission-ui="enabled:false"
  mindar-image="imageTargetSrc: ./wall-anchor.mind; autoStart: false; maxTrack: 1;"
  renderer="alpha: true; colorManagement: true; physicallyCorrectLights: true">

  <a-assets>
    <video id="vid" src="./video.mp4" loop playsinline webkit-playsinline muted preload="auto" crossorigin="anonymous"></video>
  </a-assets>

  <a-entity id="marker" mindar-image-target="targetIndex: 0"></a-entity>

  <a-entity id="wallPlane" visible="false">
    <a-video id="wallVideo" src="#vid" width="15.14" height="3.283" material="shader: flat; side: double;" position="0 0 0"></a-video>
  </a-entity>

  <a-entity camera="facingMode: environment"></a-entity>
</a-scene>

<script>
const logEl = document.getElementById('log');
const log = s=>{console.log(s); logEl.textContent += s+"\n"; logEl.scrollTop=logEl.scrollHeight;}
const statusEl = document.getElementById('status');
const btnStart = document.getElementById('btnStart');
const ctrl = document.getElementById('ctrl');
const scene = document.querySelector('a-scene');
const marker = document.getElementById('marker');
const wall   = document.getElementById('wallPlane');
const videoOverlay = document.getElementById('vid');
const bgCam = document.getElementById('bgCam');
let locked = false;

/* å¹¾ä½• */
const WALL_W=15.14, WALL_H=3.283, ANCHOR_X=1.73, ANCHOR_Y=0.46;

/* å¾®èª¿ */
const LS_KEY='WALL_AR_LOCK_V2';
let adj=JSON.parse(localStorage.getItem(LS_KEY)||'{"ox":0,"oy":0,"rz":0,"s":1}');
let step=0.02, rotStep=0.8, basePose=null;

function applyResetPose(){
  if(!basePose) return;
  wall.object3D.position.copy(basePose.pos);
  wall.object3D.quaternion.copy(basePose.quat);
  wall.object3D.scale.copy(basePose.scl);
  const q=wall.object3D.quaternion;
  const right=new THREE.Vector3(1,0,0).applyQuaternion(q);
  const up   =new THREE.Vector3(0,1,0).applyQuaternion(q);
  wall.object3D.position.addScaledVector(right,adj.ox);
  wall.object3D.position.addScaledVector(up,adj.oy);
  wall.object3D.rotateZ(THREE.MathUtils.degToRad(adj.rz));
  wall.object3D.scale.multiplyScalar(adj.s);
}
function nudge(dx,dy){adj.ox+=dx;adj.oy+=dy;applyResetPose();}
function rot(d){adj.rz+=d;applyResetPose();}
function scaleMul(m){adj.s*=m;applyResetPose();}
function setFine(){step=0.02;rotStep=0.8;log('ç²¾åº¦=ç´°');}
function setCoarse(){step=0.10;rotStep=3;log('ç²¾åº¦=ç²—');}
function saveCfg(){localStorage.setItem(LS_KEY,JSON.stringify(adj));log('å·²å„²å­˜è¨­å®šï¼š'+JSON.stringify(adj));}
function resetAdj(){adj={ox:0,oy:0,rz:0,s:1};applyResetPose();log('å·²é‡ç½®å¾®èª¿');}
function reload(){location.reload();}

async function waitSceneLoaded(el){ if(el.hasLoaded) return; await new Promise(r=>el.addEventListener('loaded',r,{once:true})); }
async function ensureCam(){
  if(!navigator.mediaDevices?.getUserMedia) throw new Error('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ getUserMedia');
  const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}},audio:false});
  s.getTracks().forEach(t=>t.stop());
}

/* å•Ÿå‹•æµç¨‹ */
btnStart.onclick = async ()=>{
  try{
    statusEl.textContent='è«‹æˆæ¬Šç›¸æ©Ÿâ€¦';
    await ensureCam();
    statusEl.textContent='å•Ÿå‹•ä¸­â€¦';
    await waitSceneLoaded(scene);

    const arSystem = scene.systems['mindar-image-system'] || scene.systems['mindar-image'] || (scene.components['mindar-image']?.system);
    if(!arSystem?.start){ statusEl.textContent='å•Ÿå‹•å¤±æ•—ï¼ˆMindAR æœªåˆå§‹åŒ–ï¼‰'; log('ğŸŸ¥ MindAR system not ready'); return; }

    await arSystem.start();
    statusEl.textContent='è«‹å°æº–éŒ¨é»';
    log('âœ… AR å·²å•Ÿå‹•ï¼Œç­‰å¾… targetFoundâ€¦');

    /* === ç›´æ¥æŠŠ MindAR çš„ video æ›åˆ°æˆ‘å€‘çš„ <video id="bgCam"> ä¸Š === */
    if (arSystem.video){
      // æœ‰äº›ç€è¦½å™¨ä¸èƒ½æŠŠåŒä¸€å€‹ MediaStream åŒæ™‚ç”¨å…©å€‹ <video>ï¼Œæˆ‘å€‘æŠŠ DOM è£¡çš„ arSystem.video ç§»åˆ°å¤–å±¤ä¸¦æ”¹ id
      try{
        arSystem.video.setAttribute('id','bgCam');
        arSystem.video.setAttribute('playsinline','');
        arSystem.video.setAttribute('webkit-playsinline','');
        arSystem.video.muted = true;
        document.body.prepend(arSystem.video);  // æ”¾åˆ°æœ€åº•å±¤
      }catch(_){}
      // ä¿éšªï¼šè‹¥ç„¡æ³•ç§»å‹•ï¼Œå°±æŠŠ stream æŒ‡çµ¦æˆ‘å€‘çš„ bgCam
      if (arSystem.video.srcObject && bgCam !== arSystem.video){
        try{ bgCam.srcObject = arSystem.video.srcObject; }catch(_){}
      }
    }

    // ç„¡è«–æ˜¯å“ªå€‹ videoï¼Œå¥—æ»¿ç‰ˆæ¨£å¼
    const camV = document.getElementById('bgCam');
    if (camV){
      camV.style.position='fixed'; camV.style.left='0'; camV.style.top='0';
      camV.style.width='100vw'; camV.style.height='100vh';
      camV.style.objectFit='cover'; camV.style.zIndex='0'; camV.style.transform='none';
      camV.addEventListener('loadedmetadata',()=>{ log(`ğŸ“· ç›¸æ©Ÿå•Ÿå‹•ï¼š${camV.videoWidth}x${camV.videoHeight}`); });
    } else{
      log('ğŸŸ¥ å–å¾— arSystem.video å¤±æ•—');
    }

  }catch(e){
    statusEl.textContent='å•Ÿå‹•å¤±æ•—';
    log('ğŸŸ¥ å•Ÿå‹•å¤±æ•—ï¼š'+e.name+' / '+e.message);
  }
};

// âœ… ç¶åœ¨éŒ¨é» entity
marker.addEventListener('targetFound', ()=>{
  log('ğŸ¯ æ‰¾åˆ°éŒ¨é» â†’ é–å®šä½å§¿');
  videoOverlay.play().catch(()=>{});
  const m = marker.object3D.matrixWorld.clone();
  wall.object3D.matrix.copy(m);
  wall.object3D.matrix.decompose(
    wall.object3D.position, wall.object3D.quaternion, wall.object3D.scale
  );
  wall.object3D.scale.set(1,1,1);

  // ä¾ä½ ç‰†é¢åº§æ¨™åšå¹³ç§»
  const q = wall.object3D.quaternion;
  const right = new THREE.Vector3(1,0,0).applyQuaternion(q);
  const up    = new THREE.Vector3(0,1,0).applyQuaternion(q);
  const dx = (WALL_W/2 - ANCHOR_X);
  const dy = (ANCHOR_Y - WALL_H/2);
  wall.object3D.position.addScaledVector(right, dx);
  wall.object3D.position.addScaledVector(up,    dy);

  wall.setAttribute('visible','true');
  locked = true;
  statusEl.textContent = 'å·²é–å®šï¼Œå¯æ ¡æ­£ä¸¦å„²å­˜';
  basePose = {
    pos: wall.object3D.position.clone(),
    quat: wall.object3D.quaternion.clone(),
    scl: wall.object3D.scale.clone()
  };
  applyResetPose();
  ctrl.style.display = 'block';
});

// å»ºè­°åŠ ä¸Š lost ä¾¿æ–¼é™¤éŒ¯
marker.addEventListener('targetLost', ()=>{
  log('ğŸŸ¡ targetLost');
});


scene.addEventListener('loaded', ()=>{
  log('å°±ç·’ï¼šæŒ‰ã€Œå•Ÿå‹• ARã€â†’ æˆæ¬Šç›¸æ©Ÿ â†’ å°æº–éŒ¨é» â†’ è‡ªå‹•é–å®š â†’ å¾®èª¿å„²å­˜ã€‚');
  setFine();
});
</script>
</body>
</html>
