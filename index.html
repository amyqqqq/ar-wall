<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>å¤§ç‰† ARï½œè¡Œå‹•è¨ºæ–·ï¼‹æµ®å‹•éµç‰ˆ</title>

<!-- A-Frame + MindAR -->
<script src="https://unpkg.com/aframe@1.4.2/dist/aframe.min.js"></script>
<script src="https://unpkg.com/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

<style>
  html,body{margin:0;height:100%;background:#000;color:#0f0;font-family:monospace;overflow:hidden;}
  a-scene{position:fixed;inset:0;width:100vw;height:100vh;z-index:1;}
  canvas.a-canvas{width:100vw;height:100vh;background:transparent;pointer-events:none;z-index:1;}
  #bgCam{position:fixed;inset:0;width:100vw;height:100vh;object-fit:cover;z-index:0;}
  .mindar-ui-loading,.mindar-ui-scanning{display:none !important;}
  #top{position:fixed;left:8px;top:8px;z-index:10;display:flex;gap:6px;align-items:center}
  #top button{padding:8px 12px}
  #log{position:fixed;left:8px;bottom:8px;right:8px;height:140px;overflow:auto;background:rgba(0,0,0,.55);padding:8px;z-index:10;font-size:12px;line-height:1.25;}
  #tfBadge{position:fixed;right:12px;top:40px;z-index:12;background:#f33;color:#fff;padding:6px 10px;border-radius:8px;display:none;font-weight:bold;}
  /* è¨ºæ–·é¢æ¿èˆ‡åŸç”Ÿæ’­æ”¾å™¨ */
  #diag{position:fixed;right:8px;bottom:72px;z-index:99999;background:#000a;color:#fff;padding:8px;border-radius:8px;max-width:70vw;font:12px monospace;display:none}
  #nativeV{display:none;position:fixed;inset:0;z-index:100000;width:100vw;height:100vh;object-fit:contain;background:#000}
  /* æ°¸é æµ®åœ¨æœ€ä¸Šå±¤çš„è¨ºæ–·éµ */
  #btnDiagFab{
    position:fixed;right:12px;bottom:12px;width:56px;height:56px;border-radius:50%;
    background:rgba(0,0,0,.8);color:#0f0;border:1px solid #0f0;
    font-weight:700;z-index:100001;box-shadow:0 2px 10px #000a;
  }
</style>
</head>
<body>
<video id="bgCam" autoplay muted playsinline webkit-playsinline></video>
<div id="tfBadge">ğŸ¯ targetFound</div>

<div id="top">
  <button id="btnStart">å•Ÿå‹• AR</button>
  <button id="btnForcePlay">â–¶ æ‰‹å‹•æ’­æ”¾</button>
  <span id="status">æœªå•Ÿå‹•</span>
</div>
<div id="log"></div>

<!-- è¨ºæ–·é¢æ¿ -->
<div id="diag">
  <div>è¨ºæ–·ï¼š<span id="dstat">æœªé–‹å§‹</span></div>
  <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">
    <button id="dPlay">åŸç”Ÿæ’­æ”¾</button>
    <button id="dClose" style="display:none">é—œé–‰åŸç”Ÿ</button>
  </div>
  <div id="dlog" style="margin-top:6px;max-height:28vh;overflow:auto;white-space:pre-wrap"></div>
</div>
<video id="nativeV" playsinline webkit-playsinline controls muted></video>

<!-- æµ®å‹•è¨ºæ–·éµ -->
<button id="btnDiagFab">è¨º</button>

<!-- AR å ´æ™¯ -->
<a-scene
  embedded color-space="sRGB"
  vr-mode-ui="enabled:false"
  device-orientation-permission-ui="enabled:false"
  mindar-image="imageTargetSrc: ./wall-anchor.mind; autoStart: false; maxTrack: 1;"
  renderer="alpha:true; colorManagement:true; physicallyCorrectLights:true">

  <a-assets timeout="30000">
    <video id="vid" preload="auto" playsinline webkit-playsinline muted crossorigin="anonymous"></video>
  </a-assets>

  <a-entity id="marker" mindar-image-target="targetIndex:0">
    <a-plane id="testOnMarker" position="0 0 0.01" width="0.6" height="0.13"
      material="shader:flat; src:#vid; side:double; transparent:true; alphaTest:0.01" visible="true"></a-plane>
  </a-entity>

  <a-entity id="wallPlane" visible="false">
    <a-plane id="wallVideo" width="15.14" height="3.283" position="0 0 0"
      material="shader:flat; src:#vid; side:double; transparent:true; alphaTest:0.01"></a-plane>
  </a-entity>

  <a-entity camera="facingMode: environment"></a-entity>
</a-scene>

<script>
const logEl=document.getElementById('log');
const log=s=>{console.log(s);logEl.textContent+=s+"\n";logEl.scrollTop=logEl.scrollHeight;}
const statusEl=document.getElementById('status');
const v=document.getElementById('vid');
const bgCam=document.getElementById('bgCam');
const wall=document.getElementById('wallPlane');
const wallVideo=document.getElementById('wallVideo');
const marker=document.getElementById('marker');
const scene=document.querySelector('a-scene');
const tfBadge=document.getElementById('tfBadge');
let locked=false;

/* å½±ç‰‡æ ¼å¼é¸æ“‡ */
const candidates = [
  {src: './video_h264_1080.mp4', type: 'video/mp4; codecs="avc1.640028"'},
  {src: './video_vp9_1080.webm', type: 'video/webm; codecs="vp9"'},
  {src: './video.mp4', type: 'video/mp4'}
];
const pick = candidates.find(c => v.canPlayType(c.type));
v.src = (pick ? pick.src : candidates[0].src);
v.muted = true; v.playsInline = true;

/* è²¼åœ–åˆ·æ–° */
AFRAME.registerComponent('video-texture-tick', {
  schema: { src: {type:'selector'} },
  init() {
    this.video = this.data.src || v;
    this.mesh = null;
    this.el.addEventListener('model-loaded', () => this.bind());
    this.bind();
  },
  bind() {
    const m = this.el.getObject3D('mesh'); if(!m) return;
    this.mesh = m;
    const mat = m.material;
    if (mat && mat.map) { mat.map.image = this.video; mat.map.needsUpdate = true; mat.needsUpdate = true; }
  },
  tick() {
    if (!this.mesh || !this.video) return;
    if (this.video.readyState >= 2) {
      const mat = this.mesh.material;
      if (mat && mat.map) mat.map.needsUpdate = true;
    }
  }
});
window.addEventListener('DOMContentLoaded', ()=>{
  wallVideo?.setAttribute('video-texture-tick','src:#vid');
  document.getElementById('testOnMarker')?.setAttribute('video-texture-tick','src:#vid');
});

/* æ’­æ”¾ä¿åº• */
function forceVideoMaterialRefresh(){
  [wallVideo, document.getElementById('testOnMarker')].forEach(p=>{
    const m=p?.getObject3D('mesh');
    if(m&&m.material){
      if(m.material.map){ m.material.map.image=v; m.material.map.needsUpdate=true; }
      m.material.needsUpdate=true;
    }
  });
}
function tryPlayVideoChain(){
  const go=()=>v.play().catch(()=>{});
  go();
  v.addEventListener('loadeddata',()=>{go();forceVideoMaterialRefresh();},{once:true});
  v.addEventListener('canplay',   ()=>{go();forceVideoMaterialRefresh();},{once:true});
  v.addEventListener('playing',   ()=>{log('ğŸï¸ playing');forceVideoMaterialRefresh();},{once:true});
  setTimeout(()=>{ if(v.readyState<2){ v.load(); go(); } forceVideoMaterialRefresh(); }, 400);
}

/* å•Ÿå‹• */
async function waitSceneLoaded(el){if(el.hasLoaded)return;await new Promise(r=>el.addEventListener('loaded',r,{once:true}));}
async function ensureCam(){
  if(!navigator.mediaDevices?.getUserMedia)throw new Error('ç„¡æ³•å–ç”¨ç›¸æ©Ÿ');
  const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}},audio:false});
  s.getTracks().forEach(t=>t.stop());
}
document.getElementById('btnStart').onclick=async()=>{
  try{
    statusEl.textContent='è«‹æˆæ¬Šç›¸æ©Ÿâ€¦';
    await ensureCam();
    statusEl.textContent='å•Ÿå‹•ä¸­â€¦';
    await waitSceneLoaded(scene);
    const arSystem=scene.systems['mindar-image-system']||scene.systems['mindar-image'];
    await arSystem.start();
    statusEl.textContent='è«‹å°æº–éŒ¨é»';
    log('âœ… AR å·²å•Ÿå‹•');
    if(arSystem.video && arSystem.video.srcObject){
      bgCam.srcObject=arSystem.video.srcObject; bgCam.play().catch(()=>{});
    }
    v.load(); tryPlayVideoChain();
    setTimeout(()=>{ if(!locked){ wall.setAttribute('visible','true'); tryPlayVideoChain(); }},2000);
  }catch(e){ statusEl.textContent='å•Ÿå‹•å¤±æ•—'; log('ğŸŸ¥ '+e.message); }
};

/* æ‰‹å‹¢ä¿åº• */
window.addEventListener('touchstart', ()=>{v.play().catch(()=>{});},{once:true,passive:true});
window.addEventListener('pointerdown', ()=>{v.play().catch(()=>{});},{once:true});
document.getElementById('btnForcePlay').onclick=()=>{v.play().then(()=>log('â–¶ï¸ æ‰‹å‹•æ’­æ”¾æˆåŠŸ')).catch(e=>log('ğŸŸ¥ '+e.message));};

/* target */
marker.addEventListener('targetFound',()=>{
  log('ğŸ¯ targetFound'); tfBadge.style.display='block';
  tryPlayVideoChain();
  const m=marker.object3D.matrixWorld.clone();
  wall.object3D.matrix.copy(m);
  wall.object3D.matrix.decompose(wall.object3D.position,wall.object3D.quaternion,wall.object3D.scale);
  wall.setAttribute('visible','true');
  locked=true;
});
marker.addEventListener('targetLost',()=>{tfBadge.style.display='none';});

/* === è¨ºæ–· === */
const nv=document.getElementById('nativeV');
const diag=document.getElementById('diag');
const dstat=document.getElementById('dstat');
const dlog=document.getElementById('dlog');
const dPlay=document.getElementById('dPlay');
const dClose=document.getElementById('dClose');
function logD(s){dlog.textContent+=s+'\n';dlog.scrollTop=dlog.scrollHeight;}
function updateStat(){dstat.textContent=`readyState=${v.readyState} networkState=${v.networkState} muted=${v.muted}`;}
['loadedmetadata','loadeddata','canplay','playing','pause','ended','waiting','stalled','suspend','error']
  .forEach(ev=>v.addEventListener(ev,()=>{logD('video event:'+ev);updateStat();}));
dPlay.onclick=async()=>{nv.src=v.currentSrc||v.src;nv.muted=true;nv.style.display='block';dClose.style.display='inline-block';try{await nv.play();logD('âœ… åŸç”Ÿæ’­æ”¾æˆåŠŸ');}catch(e){logD('âŒ '+e.message);}updateStat();};
dClose.onclick=()=>{nv.pause();nv.style.display='none';dClose.style.display='none';};

/* æµ®å‹•éµåŠŸèƒ½ */
document.getElementById('btnDiagFab').onclick=()=>{
  diag.style.display='block';
  diag.style.zIndex=100000;
  nv.src=v.currentSrc||v.src;
  nv.muted=true;
  nv.style.display='block';
  nv.play().catch(()=>{});
};

/* Blob è¼‰å…¥ï¼ˆé˜²è·¨åŸŸï¼‰ */
(async()=>{
  const src=v.currentSrc||v.src;if(!src)return;
  try{
    const res=await fetch(src);if(!res.ok)throw new Error(res.status);
    const blob=await res.blob();const url=URL.createObjectURL(blob);
    v.src=url;nv.src=url;v.muted=true;nv.muted=true;await v.play().catch(()=>{});
    log('âœ… Blob å½±ç‰‡è¼‰å…¥');
  }catch(e){log('âŒ Blob å¤±æ•— '+e.message);}
})();
</script>
</body>
</html>
