<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>å¤§ç‰† ARï½œå¤§ç‰†å°é½Šï¼‹éŒ„å½±ç‰ˆ</title>

<!-- å®˜æ–¹ A-Frame + mind-ar -->
<script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

<style>
  body{
    margin:0;
    overflow:hidden;
    background:#000;
    color:#0f0;
    font-family:monospace;
  }

  #top{
    position:fixed;
    left:8px;
    top:8px;
    z-index:10;
    display:flex;
    gap:6px;
    align-items:center;
    padding:4px 6px;
    background:rgba(0,0,0,.45);
    border-radius:8px;
    flex-wrap:wrap;
  }
  #top button{
    padding:3px 6px;
    font-size:12px;
  }
  #status{
    font-size:12px;
    opacity:.85;
    min-width:140px;
  }
  #posInfo{
    font-size:11px;
    opacity:.8;
  }
</style>
</head>
<body>

<div id="top">
  <button id="btnWall" disabled>åˆ‡åˆ°å¤§ç‰†</button>
  <button id="btnLeft">â¬…</button>
  <button id="btnRight">â¡</button>
  <button id="btnUp">â¬†</button>
  <button id="btnDown">â¬‡</button>
  <button id="btnRecStart">ğŸ”´ é–‹å§‹éŒ„å½±</button>
  <button id="btnRecStop" disabled>â¹ åœæ­¢</button>
  <span id="status">ç­‰å¾…éŒ¨é»â€¦</span>
  <span id="posInfo"></span>
</div>

<a-scene
  mindar-image="imageTargetSrc: ./wall-anchor.mind?v=20251113; autoStart: true"
  color-space="sRGB"
  renderer="colorManagement: true; physicallyCorrectLights: true"
  vr-mode-ui="enabled: false"
  device-orientation-permission-ui="enabled: false">

  <a-assets timeout="30000">
    <video id="vid" src="./video.mp4"
           preload="auto"
           playsinline webkit-playsinline
           muted
           crossorigin="anonymous"></video>
  </a-assets>

  <!-- camera -->
  <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

  <!-- markerï¼šåŒä¸€å¡Š planeï¼Œå…ˆå°å¾Œå¤§ -->
  <a-entity id="marker" mindar-image-target="targetIndex:0">
    <a-plane id="plane"
      position="0 0 0"
      width="0.8" height="0.4"
      material="shader:flat; src:#vid; side:double; transparent:true; alphaTest:0.01">
    </a-plane>
  </a-entity>

</a-scene>

<script>
const v        = document.getElementById('vid');
const marker   = document.getElementById('marker');
const plane    = document.getElementById('plane');
const btnWall  = document.getElementById('btnWall');
const btnLeft  = document.getElementById('btnLeft');
const btnRight = document.getElementById('btnRight');
const btnUp    = document.getElementById('btnUp');
const btnDown  = document.getElementById('btnDown');
const btnRecStart = document.getElementById('btnRecStart');
const btnRecStop  = document.getElementById('btnRecStop');
const statusEl = document.getElementById('status');
const posInfo  = document.getElementById('posInfo');

let hasFound   = false;
let isWallMode = false;

// ç‰†å¯¦éš›å°ºå¯¸ï¼ˆå…¬å°ºï¼‰
const WALL_W = 15.14;
const WALL_H = 3.283;

// ä¼°è¨ˆéŒ¨é»åœ¨æ•´é¢ç‰†ä¸­åå·¦ â‰ˆ 6.2mï¼ˆç‰†ä¸­å¿ƒç‚º 0ï¼Œå¾€å³ç‚º +Xï¼‰
let wallPos = { x: 6.2, y: 0, z: 0 };

function updatePosLabel(){
  posInfo.textContent = `pos x=${wallPos.x.toFixed(2)}m, y=${wallPos.y.toFixed(2)}m`;
}

// æ‰‹æ©Ÿäº’å‹•ä¸€æ¬¡çµ¦å½±ç‰‡æ’­æ”¾æ¬Šé™
function tryPlay(){ v.play().catch(()=>{}); }
['loadeddata','canplay'].forEach(ev => v.addEventListener(ev, tryPlay, {once:true}));
window.addEventListener('pointerdown', tryPlay, {once:true});
window.addEventListener('touchstart', tryPlay, {once:true, passive:true});

// éŒ¨é»äº‹ä»¶
marker.addEventListener('targetFound', () => {
  console.log('ğŸ¯ targetFound');
  statusEl.textContent = 'å·²é–å®šéŒ¨é»ï¼Œå¯åˆ‡åˆ°å¤§ç‰†';
  hasFound = true;
  btnWall.disabled = false;
  v.play().catch(()=>{});
});

marker.addEventListener('targetLost', () => {
  console.log('âš  targetLost');
  statusEl.textContent = 'éŒ¨é»éºå¤±ï¼Œè«‹å†å°æº–';
  hasFound = false;
});

// åˆ‡åˆ°å¤§ç‰†ï¼šæ”¾å¤§åŒä¸€å¡Š planeï¼Œä¸¦å¥—ç”¨é ä¼°ä½ç½®
btnWall.addEventListener('click', () => {
  if(!hasFound) return;

  plane.setAttribute('width',  WALL_W);
  plane.setAttribute('height', WALL_H);
  plane.setAttribute('position', `${wallPos.x} ${wallPos.y} ${wallPos.z}`);

  isWallMode = true;
  statusEl.textContent = 'å¤§ç‰†æ¨¡å¼ï¼šå¯ç”¨ç®­é ­å¾®èª¿ä½ç½®ï¼ˆéŒ„å½±ä¹ŸæœƒéŒ„é€²å»ï¼‰';
  updatePosLabel();
  v.play().catch(()=>{});
});

// å¾®èª¿ï¼ˆå·¦å³ä¸Šä¸‹ï¼‰
function nudge(dx, dy){
  if(!isWallMode) return;
  wallPos.x += dx;
  wallPos.y += dy;
  plane.setAttribute('position', `${wallPos.x} ${wallPos.y} ${wallPos.z}`);
  updatePosLabel();
}

btnLeft .addEventListener('click', () => nudge(-0.1, 0));
btnRight.addEventListener('click', () => nudge( 0.1, 0));
btnUp   .addEventListener('click', () => nudge(0,  0.1));
btnDown .addEventListener('click', () => nudge(0, -0.1));

updatePosLabel();

/* ========= éŒ„å½±åŠŸèƒ½ï¼šMediaRecorder + canvas.captureStream ========= */

let canvas = null;
let mediaRecorder = null;
let recordedChunks = [];

// ç­‰ a-scene è¼‰å…¥å¾Œï¼Œå–å¾— WebGL canvas
const scene = document.querySelector('a-scene');
scene.addEventListener('loaded', () => {
  canvas = scene.canvas || document.querySelector('canvas.a-canvas');
  console.log('ğŸ¥ canvas ready for capture', canvas);
});

function setRecButtonState(isRecording){
  btnRecStart.disabled = isRecording;
  btnRecStop.disabled  = !isRecording;
}

// é–‹å§‹éŒ„å½±
btnRecStart.addEventListener('click', () => {
  if(!canvas){
    alert('æš«æ™‚æ‰¾ä¸åˆ°ç•«é¢ä¾†æºï¼Œè«‹ç¨å€™å¹¾ç§’å†è©¦ä¸€æ¬¡ã€‚');
    return;
  }
  if(typeof MediaRecorder === 'undefined'){
    alert('æ­¤è£ç½®æˆ–ç€è¦½å™¨ä¸æ”¯æ´éŒ„å½±ï¼ˆMediaRecorderï¼‰ã€‚\nå¯ä»¥æ”¹ç”¨æ‰‹æ©Ÿå…§å»ºè¢å¹•éŒ„å½±ã€‚');
    return;
  }

  try{
    const stream = canvas.captureStream(30); // 30fps
    recordedChunks = [];
    mediaRecorder = new MediaRecorder(stream); // è®“ç€è¦½å™¨è‡ªé¸ codec

    mediaRecorder.ondataavailable = e => {
      if(e.data && e.data.size > 0) recordedChunks.push(e.data);
    };

    mediaRecorder.onstop = () => {
      const blob = new Blob(recordedChunks, {type:'video/webm'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ar-record.webm';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      recordedChunks = [];
      setRecButtonState(false);
      statusEl.textContent = 'éŒ„å½±å·²å„²å­˜ï¼ˆar-record.webmï¼‰';
    };

    mediaRecorder.start();
    setRecButtonState(true);
    statusEl.textContent = 'éŒ„å½±ä¸­â€¦ å†æŒ‰ã€Œåœæ­¢ã€çµæŸä¸¦ä¸‹è¼‰æª”æ¡ˆ';
    console.log('ğŸ¥ recording started');
  }catch(err){
    console.error(err);
    alert('ç„¡æ³•é–‹å§‹éŒ„å½±ï¼š' + err.message);
  }
});

// åœæ­¢éŒ„å½±
btnRecStop.addEventListener('click', () => {
  if(mediaRecorder && mediaRecorder.state === 'recording'){
    mediaRecorder.stop();
    console.log('ğŸ¥ recording stopped');
  }
});
</script>
</body>
</html>
